{% extends "base.html" %}

{% block title %}?âÍ? - {{ evaluation_type }}{% endblock %}

{% block extra_css %}
<style>
.evaluation-card {
    border: 2px solid #1a1a2e;
    border-radius: 15px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.evaluation-card:hover {
    border-color: #16213e;
    box-shadow: 0 4px 8px rgba(22, 33, 62, 0.1);
}

.evaluation-card.selected {
    border-color: #16213e;
    background-color: #f8f9ff;
}

.score-input {
    width: 100px;
    text-align: center;
    border-radius: 8px;
    border: 2px solid #1a1a2e;
    padding: 8px;
    font-weight: bold;
    font-size: 14px;
}

.score-input:focus {
    border-color: #16213e;
    box-shadow: 0 0 0 0.2rem rgba(22, 33, 62, 0.25);
}

.absolute-evaluation {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1a1a2e;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #90caf9;
}

.relative-evaluation {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.criteria-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.performance-view {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #16213e;
}

/* ÏµúÏ¢Ö ?úÏ∂ú Î≤ÑÌäº ?§Ì???*/
.btn-final-submit {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    font-weight: bold;
}

.btn-final-submit:hover {
    background-color: #c82333;
    border-color: #bd2130;
    color: white;
}

/* ?ÑÏãú?Ä??Î≤ÑÌäº ?§Ì???*/
.btn-temp-save {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-temp-save:hover {
    background-color: #5a6268;
    border-color: #545b62;
    color: white;
}

/* ?§Ï†Å Ï°∞Ìöå Î≤ÑÌäº ?§Ì???*/
.btn-performance-view {
    background-color: #16213e;
    border-color: #16213e;
    color: white;
}

.btn-performance-view:hover {
    background-color: #1a1a2e;
    border-color: #1a1a2e;
    color: white;
}

/* ?¨Ïù∏???úÎèÑ ?åÎ¶º ?§Ì???*/
.alert-info {
    background-color: #e3f2fd;
    border-color: #16213e;
    color: #1a1a2e;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #16213e;
    color: #1a1a2e;
}

/* ?åÎ™Ö??Í≤ΩÍ≥† ?§Ì???*/
.alert-warning .alert-warning {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="user-info">
    <div class="row">
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>?âÍ???/h6>
            <p class="mb-0">{{ user_data.name }}</p>
        </div>
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>?åÏÜç</h6>
            <p class="mb-0">{{ user_data.team }}</p>
        </div>
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>?âÍ? ?†Ìòï</h6>
                            <p class="mb-0">
                    {% if evaluation_type == 'employee' %}?Ä???âÍ?(?¨Ïõê)
                    {% elif evaluation_type == 'manager' and session['user_type'] == '?âÍ????Ä??' %}?Ä???âÍ?(?ÄÎ¶??¥ÏÉÅ)
                    {% elif evaluation_type == 'manager' and session['user_type'] == '?âÍ????ÑÏõê)' %}?Ä???âÍ?(Í¥ÄÎ¶¨ÏßÅ)
                    {% elif evaluation_type == 'general' %}?Ä???âÍ?(?ºÎ∞òÏß?
                    {% elif evaluation_type == 'team_leader' %}?Ä???âÍ?
                    {% endif %}
                </p>
        </div>
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>?âÍ? ?Ä??/h6>
            <p class="mb-0">{{ evaluatees|length }}Î™?/p>
        </div>
    </div>
</div>

{% if evaluation_type == 'employee' %}
<div class="absolute-evaluation">
    <h5><i class="fas fa-star me-2"></i>?àÎ??âÍ? ?àÎÇ¥</h5>
    <ul class="mb-0">
        <li>S(10??, A(8??, B(6??, C(4??, D(2?? ?±Í∏âÎ≥??âÍ?</li>
        <li>ÏßÅÍ∏â Ï≤¥Î•òÍ∏∞Í∞Ñ ?âÍ∑† ?êÏàòÍ∞Ä 60??ÎØ∏Îßå?¥Î©¥ ?ÄÎ¶??πÏßÑ ?úÏô∏</li>
        <li>Í∞??âÍ? ??™©Î≥ÑÎ°ú ?±Í∏â???†ÌÉù?òÏÑ∏??/li>
    </ul>
</div>
{% elif evaluation_type == 'general' %}
<div class="alert alert-info">
    <h5><i class="fas fa-comment me-2"></i>?ºÎ∞òÏß??âÍ? ?àÎÇ¥</h5>
    {% if session['user_type'] == '?âÍ????Ä??' %}
    <p class="mb-0">?ºÎ∞òÏß??âÍ????âÍ? ?òÍ≤¨Îß??ëÏÑ±?òÏãúÎ©??©Îãà?? ?êÏàò ?ÖÎ†•?Ä ?ÑÏöî?òÏ? ?äÏäµ?àÎã§.</p>
    {% elif session['user_type'] == '?âÍ????ÑÏõê)' %}
    <p class="mb-0">?ÅÎ??âÍ?: ?∏Ïõê??√ó 85 ?¨Ïù∏?? ?∏Îãπ ÏµúÏÜå 65?? ÏµúÎ? 105??/p>
    {% endif %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        {% if evaluation_type == 'employee' %}
        <!-- ?àÎ??âÍ? ??-->
        {% for grade, grade_evaluatees in grade_groups.items() %}
        <div class="grade-group mb-4">
            <h6 class="text-primary mb-3">{{ grade }} ÏßÅÍ∏â ({{ grade_evaluatees|length }}Î™?</h6>
            
            {% for evaluatee in grade_evaluatees %}
            <div class="evaluation-card" id="evaluatee-{{ evaluatee.id }}">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>{{ evaluatee.name }}
                            </h6>
                            <small class="text-dark">{{ evaluatee.team }} | {{ evaluatee.position }} | {{ evaluatee.grade }}</small>
                        </div>
                        <div class="col-md-6 text-end">
                            {% if evaluatee.before_point %}
                            <span class="badge bg-info">ÏßÅÏ†Ñ ?âÍ?: {{ evaluatee.before_point }}??/span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- ?§Ï†Å Ï°∞Ìöå -->
                    <div class="performance-view">
                        <h6><i class="fas fa-file-alt me-2"></i>?ëÏÑ±???§Ï†Å</h6>
                        <div id="performance-{{ evaluatee.id|string }}">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPerformance('{{ evaluatee.id|string }}')">
                                <i class="fas fa-eye me-1"></i>?§Ï†Å Ï°∞Ìöå
                            </button>
                        </div>
                    </div>
                    
                    <!-- ?àÎ??âÍ? -->
                    <div class="absolute-evaluation-form">
                        <h6><i class="fas fa-star me-2"></i>?àÎ??âÍ?</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>?âÍ? ??™©</th>
                                        <th>S(10??</th>
                                        <th>A(8??</th>
                                        <th>B(6??</th>
                                        <th>C(4??</th>
                                        <th>D(2??</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Í∑ºÎ¨¥?úÎèÑ - Í∑ºÎ¨¥?úÍ∞Ñ Ï§Ä??Î∞??ÖÎ¨¥ ÏßëÏ§ë</td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>Í∑ºÎ¨¥?úÎèÑ - ÏßÅÏû• ???àÏùòÎ≤îÏ†à Ï§Ä??/td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>Í∑ºÎ¨¥?úÎèÑ - Ï±ÖÏûÑÍ∞??àÎäî ?ÖÎ¨¥ ?òÌñâ</td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?îÎ°ú?åÏã≠ - Ï£ºÏñ¥Ïß???ï† ?ÅÍ∑π ?òÏö©</td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?îÎ°ú?åÏã≠ - ?Ä Î™©Ìëú ?¨ÏÑ± ÏßÄ??Î∞??ëÎ†•</td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?îÎ°ú?åÏã≠ - Ï°∞ÏßÅ Í∞ÄÏπòÏ? Î¨∏Ìôî ?¥Ìï¥ Î∞??ÅÏùë</td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?ÖÎ¨¥?òÌñâ ?•Î†• - ?ÖÎ¨¥ ?¥Ïö© ?¥Ìï¥ Î∞??ïÌôï???òÌñâ</td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?ÖÎ¨¥?òÌñâ ?•Î†• - Í∏∞Ìïú ???ÖÎ¨¥ ?ÑÎ£å</td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?±Ïû• ÎßàÏù∏?úÏÖã - ?àÎ°ú??ÏßÄ???µÎìù Î∞??úÏö©</td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>?±Ïû• ÎßàÏù∏?úÏÖã - ?ºÎìúÎ∞??òÏö© Î∞??êÍ∏∞Í≥ÑÎ∞ú ÏßÄ??/td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end">
                            <strong>Ï¥ùÏ†ê: <span id="total-score-{{ evaluatee.id }}">0</span>/100??/strong>
                        </div>
                    </div>
                    
                    <!-- ?âÍ? ?òÍ≤¨ -->
                    <div class="mt-3">
                        <label class="form-label">?âÍ? ?òÍ≤¨</label>
                        <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" 
                                  placeholder="?âÍ? ?òÍ≤¨???ëÏÑ±?òÏÑ∏??.."></textarea>
                    </div>
                    
                    <div class="mt-3 text-end">
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        
        <!-- ?àÎ??âÍ? ?ÑÏãú?Ä??ÏµúÏ¢Ö?úÏ∂ú Î≤ÑÌäº -->
        <div class="d-flex gap-2 mt-4">
            <button type="button" class="btn btn-sm btn-temp-save" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                <i class="fas fa-save me-1"></i>?ÑÏãú?Ä??
            </button>
            <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                <i class="fas fa-paper-plane me-1"></i>ÏµúÏ¢Ö ?úÏ∂ú
            </button>
        </div>
        
        {% elif evaluation_type in ['manager', 'team_leader'] %}
        <!-- ?ÅÎ??âÍ? ??-->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>?ÅÎ??âÍ?
                </h5>
                {% if (session['user_type'] == '?âÍ????ÑÏõê)' and evaluation_type in ['manager', 'team_leader']) or (session['user_type'] == '?âÍ????Ä??' and evaluation_type == 'manager') %}
                <div>
                    <button type="button" class="btn btn-sm btn-temp-save me-2" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                        <i class="fas fa-save me-1"></i>?ÑÏãú?Ä??
                    </button>
                    <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                        <i class="fas fa-paper-plane me-1"></i>ÏµúÏ¢Ö ?úÏ∂ú
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if session['user_type'] == '?âÍ????ÑÏõê)' %}
                {# ?ÑÏõê?Ä ÏßÅÍ∏âÎ≥?Í∑∏Î£π #}
                {% for grade, grade_evaluatees in grade_groups.items() %}
                <div class="grade-group mb-4">
                    <h6 class="text-primary mb-3">{{ grade }} ÏßÅÍ∏â ({{ grade_evaluatees|length }}Î™?</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>?¨Ïù∏???úÎèÑ:</strong> 
                                {% if evaluation_type == 'team_leader' %}
                                    ?∏Ïõê??√ó 85 ?¨Ïù∏?? ?∏Îãπ ÏµúÎ? 105?? ÏµúÏÜå 75??
                                {% elif evaluation_type == 'manager' %}
                                    ?∏Ïõê??√ó 5 ?¨Ïù∏?? ?∏Îãπ ÏµúÎ? 10?? ÏµúÏÜå 0??
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <strong>?®Ï? ?¨Ïù∏??</strong> <span id="remaining-points-{{ grade }}">-</span>
                            </div>
                        </div>
                    </div>
                    
                    {% for evaluatee in grade_evaluatees %}
                    <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 class="mb-1">{{ evaluatee.name }}</h6>
                                <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                                {% if evaluatee.before_point %}
                                <div class="mt-1">
                                    <small class="text-info">?Ä???âÍ?: {{ evaluatee.before_point }}??/small>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">?âÍ? ?êÏàò</label>
                                        <input type="number" class="form-control score-input" id="score-{{ evaluatee.id }}" 
                                               min="0" max="105" step="1" placeholder="?êÏàò ?ÖÎ†•"
                                               data-before-point="{{ evaluatee.before_point or 0 }}"
                                               oninput="updateTotalScore('{{ evaluatee.id }}')">
                                        <div id="total-score-{{ evaluatee.id }}" class="mt-1">
                                            <small class="text-success"><strong>?©Í≥Ñ: <span id="total-{{ evaluatee.id }}">0</span>??/strong></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-sm btn-performance-view" onclick="loadPerformance('{{ evaluatee.id }}')">
                                    <i class="fas fa-eye me-1"></i>?§Ï†Å Ï°∞Ìöå
                                </button>
                            </div>
                        </div>
                        <!-- ?§Ï†Å ?úÏãú ?ÅÏó≠ Ï∂îÍ? -->
                        <div id="performance-{{ evaluatee.id }}" class="mt-3"></div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">?âÍ? ?òÍ≤¨</label>
                                <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="?âÍ? ?òÍ≤¨???ëÏÑ±?¥Ï£º?∏Ïöî"></textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                {% else %}
                {# ?Ä?•Ï? ?âÎ©¥ Î¶¨Ïä§??#}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <strong>?¨Ïù∏???úÎèÑ:</strong> ?∏Ïõê??√ó 80 ?¨Ïù∏?? ?∏Îãπ ?úÎèÑ 65~95??
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <strong>?®Ï? ?¨Ïù∏??</strong> <span id="remaining-points-manager">{{ evaluatees|length * 80 }}</span>
                        </div>
                    </div>
                </div>
                {% for evaluatee in evaluatees %}
                <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ evaluatee.name }}</h6>
                            <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                            {% if evaluatee.before_point %}
                            <div class="mt-1">
                                <small class="text-info">ÏßÅÏ†Ñ ?êÏàò: {{ evaluatee.before_point }}??/small>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">?âÍ? ?êÏàò</label>
                                    <input type="number" class="form-control score-input" id="score-{{ evaluatee.id }}" 
                                           min="65" max="95" step="1" placeholder="?êÏàò ?ÖÎ†•"
                                           data-before-point="{{ evaluatee.before_point or 0 }}"
                                           oninput="checkScoreDifference('{{ evaluatee.id }}')">
                                    <div id="explanation-{{ evaluatee.id }}" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPerformance('{{ evaluatee.id|string }}')">
                                <i class="fas fa-eye me-1"></i>?§Ï†Å Ï°∞Ìöå
                            </button>
                        </div>
                    </div>
                    <!-- ?§Ï†Å ?úÏãú ?ÅÏó≠ Ï∂îÍ? -->
                    <div id="performance-{{ evaluatee.id|string }}" class="mt-3"></div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">?âÍ? ?òÍ≤¨</label>
                            <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="?âÍ? ?òÍ≤¨???ëÏÑ±?¥Ï£º?∏Ïöî"></textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% elif evaluation_type == 'general' %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comment me-2"></i>?ºÎ∞òÏß??âÍ?</h5>
                {% if session['user_type'] == '?âÍ????ÑÏõê)' %}
                <div>
                    <button type="button" class="btn btn-sm btn-temp-save me-2" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                        <i class="fas fa-save me-1"></i>?ÑÏãú?Ä??
                    </button>
                    <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                        <i class="fas fa-paper-plane me-1"></i>ÏµúÏ¢Ö ?úÏ∂ú
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if session['user_type'] == '?âÍ????Ä??' %}
                <div class="alert alert-info mb-3">?ºÎ∞òÏß??âÍ????âÍ? ?òÍ≤¨Îß??ëÏÑ±?òÏãúÎ©??©Îãà??</div>
                {% for evaluatee in evaluatees %}
                <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ evaluatee.name }}</h6>
                            <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                        </div>
                        <div class="col-md-8 text-end">
                            <button type="button" class="btn btn-sm btn-performance-view" onclick="loadPerformance('{{ evaluatee.id|string }}')">
                                <i class="fas fa-eye me-1"></i>?§Ï†Å Ï°∞Ìöå
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">?âÍ? ?òÍ≤¨</label>
                            <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="?âÍ? ?òÍ≤¨???ëÏÑ±?¥Ï£º?∏Ïöî"></textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-sm btn-temp-save" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                        <i class="fas fa-save me-1"></i>?ÑÏãú?Ä??
                    </button>
                    <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                        <i class="fas fa-paper-plane me-1"></i>ÏµúÏ¢Ö ?úÏ∂ú
                    </button>
                </div>
                {% elif session['user_type'] == '?âÍ????ÑÏõê)' %}
                {% for grade, grade_evaluatees in grade_groups.items() %}
                <div class="grade-group mb-4">
                    <h6 class="text-primary mb-3">{{ grade }} ÏßÅÍ∏â ({{ grade_evaluatees|length }}Î™?</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info"><strong>?¨Ïù∏???úÎèÑ:</strong> Ï¥?{{ grade_evaluatees|length * 85 }}??/div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning"><strong>?®Ï? ?¨Ïù∏??</strong> <span id="remaining-points-{{ grade }}">-</span></div>
                        </div>
                    </div>
                    {% for evaluatee in grade_evaluatees %}
                    <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 class="mb-1">{{ evaluatee.name }}</h6>
                                <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">?âÍ? ?êÏàò</label>
                                        <input type="number" class="form-control score-input" id="score-{{ evaluatee.id }}" min="65" max="105" step="1" placeholder="?êÏàò ?ÖÎ†•">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-sm btn-performance-view" onclick="loadPerformance('{{ evaluatee.id }}')">
                                    <i class="fas fa-eye me-1"></i>?§Ï†Å Ï°∞Ìöå
                                </button>
                            </div>
                        </div>
                        <!-- ?§Ï†Å ?úÏãú ?ÅÏó≠ Ï∂îÍ? -->
                        <div id="performance-{{ evaluatee.id }}" class="mt-3"></div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">?âÍ? ?òÍ≤¨</label>
                                <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="?âÍ? ?òÍ≤¨???ëÏÑ±?¥Ï£º?∏Ïöî"></textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    {% if evaluation_type != 'general' %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>ÏßÅÍ∏âÎ≥???ï† ?ïÏùò
                </h5>
            </div>
            <div class="card-body text-center">
                {% if jikkeup is not none and not jikkeup.empty %}
                <button type="button" class="btn btn-primary btn-lg" onclick="showJobRoleDefinitions()">
                    <i class="fas fa-eye me-2"></i>ÏßÅÍ∏âÎ≥???ï† ?ïÏùò Î≥¥Í∏∞
                </button>
                <p class="text-muted mt-2 small">?¥Î¶≠?òÏó¨ Í∞?ÏßÅÍ∏â????ï† ?ïÏùò?Ä ?âÎèô ÏßÄÏπ®ÏùÑ ?ïÏù∏?òÏÑ∏??/p>
                
                <!-- ?®Í≤®Ïß?ÏßÅÍ∏âÎ≥???ï† ?ïÏùò ?∞Ïù¥??-->
                <div id="job-role-data" style="display: none;">
                    {% for _, row in jikkeup.iterrows() %}
                    <div class="job-role-item" 
                         data-title="{{ row.iloc[0] }}" 
                         data-definition="{{ row.iloc[2] }}" 
                         data-guidelines="{{ row.iloc[3] }}">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">ÏßÅÍ∏âÎ≥???ï† ?ïÏùòÎ•?Î∂àÎü¨?????ÜÏäµ?àÎã§.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- ÏßÅÍ∏âÎ≥???ï† ?ïÏùò ?ÅÏÑ∏ Î™®Îã¨ -->
<div class="modal fade" id="jobDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i><span id="jobTitle"></span> ??ï† ?ïÏùò
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jobDefinition"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">?´Í∏∞</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ?©Í≥Ñ ?êÏàò ?ÖÎç∞?¥Ìä∏ ?®Ïàò (?âÍ????ÑÏõê) ?Ä???âÍ?(Í¥ÄÎ¶¨ÏßÅ)??
function updateTotalScore(evaluateeId) {
    const scoreInput = document.getElementById(`score-${evaluateeId}`);
    const totalSpan = document.getElementById(`total-${evaluateeId}`);
    
    if (!scoreInput || !totalSpan) return;
    
    const currentScore = parseInt(scoreInput.value) || 0;
    const beforePoint = parseInt(scoreInput.getAttribute('data-before-point')) || 0;
    
    // ?Ä???âÍ? ?êÏàò + ?ÑÏû¨ ?âÍ? ?êÏàò = ?©Í≥Ñ
    const totalScore = beforePoint + currentScore;
    
    totalSpan.textContent = totalScore;
    
    // ?©Í≥Ñ ?êÏàò???∞Î•∏ ?âÏÉÅ Î≥ÄÍ≤?
    const totalScoreDiv = document.getElementById(`total-score-${evaluateeId}`);
    if (totalScoreDiv) {
        const totalElement = totalScoreDiv.querySelector('small');
        if (totalElement) {
            if (totalScore >= 90) {
                totalElement.className = 'text-success fw-bold';
            } else if (totalScore >= 80) {
                totalElement.className = 'text-primary fw-bold';
            } else if (totalScore >= 70) {
                totalElement.className = 'text-warning fw-bold';
            } else {
                totalElement.className = 'text-danger fw-bold';
            }
        }
    }
}

// ?§Ï†Å Ï°∞Ìöå
function loadPerformance(employeeId) {
    console.log('?§Ï†Å Ï°∞Ìöå ?úÏûë:', employeeId);
    
    // Î™®Îì† Í∞Ä?•Ìïú ID ?ïÏãù ?úÎèÑ
    const possibleIds = [
        'performance-' + employeeId,
        'performance-' + String(employeeId),
        'performance-' + employeeId.toString()
    ];
    
    let container = null;
    for (const id of possibleIds) {
        container = document.getElementById(id);
        if (container) {
            console.log('Ï∞æÏ? Ïª®ÌÖå?¥ÎÑà ID:', id);
            break;
        }
    }
    
    if (!container) {
        console.error('Ïª®ÌÖå?¥ÎÑàÎ•?Ï∞æÏùÑ ???ÜÏäµ?àÎã§. ?úÎèÑ??ID??', possibleIds);
        // ?òÏù¥ÏßÄ??Î™®Îì† div ?îÏÜå Ï∂úÎ†•
        const allDivs = document.querySelectorAll('div[id^="performance-"]');
        console.log('?òÏù¥ÏßÄ??performance-Î°??úÏûë?òÎäî Î™®Îì† div:', allDivs);
        return;
    }
    
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Î°úÎî© Ï§?..</div>';
    
    fetch('/get_performance/' + employeeId)
        .then(response => response.json())
        .then(data => {
            console.log('Î∞õÏ? ?∞Ïù¥??', data);
            
            if (data.success && data.data && data.data.length > 0) {
                let html = '<div class="alert alert-info">';
                data.data.forEach((perf, index) => {
                    if (index > 0) html += '<div class="border-top pt-3 mb-3"></div>';
                    html += '<h6 class="mb-2"><i class="fas fa-list-ol me-1"></i>?§Ï†Å ' + perf.order + '</h6>';
                    html += '<p class="mb-1"><strong>Í≥ºÏ†úÎ™?</strong> ' + perf.project_name + '</p>';
                    html += '<p class="mb-2" style="white-space: pre-line;">' + perf.performance + '</p>';
                    html += '<small class="text-muted">?ëÏÑ±?? ' + perf.created_at + '</small>';
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-1"></i>?§Ï†Å ?∞Ïù¥?∞Í? ?ÜÏäµ?àÎã§.</div>';
            }
        })
        .catch(error => {
            console.error('?§Ï†Å Ï°∞Ìöå ?§Î•ò:', error);
            container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>?§Ï†Å Ï°∞Ìöå Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.</div>';
        });
}

// ?àÎ??âÍ? Ï¥ùÏ†ê Í≥ÑÏÇ∞
function calculateTotalScore(employeeId) {
    const radios = document.querySelectorAll(`input[name$="_${employeeId}"]:checked`);
    let total = 0;
    radios.forEach(radio => {
        total += parseInt(radio.value);
    });
    document.getElementById(`total-score-${employeeId}`).textContent = total;
}

// ?ÅÎ??âÍ? ?êÏàò Ï∞®Ïù¥ Í≥ÑÏÇ∞ (?úÍ±∞??- ?Ä???âÍ? ?ÄÎπ?Í∏∞Îä• ?úÍ±∞)
function calculateScoreDiff(employeeId) {
    // ???®Ïàò?????¥ÏÉÅ ?¨Ïö©?òÏ? ?äÏäµ?àÎã§
    // ?Ä???âÍ? ?ÄÎπ?Í∏∞Îä•???úÍ±∞?òÏóà?µÎãà??
}

// ÏßÅÍ∏âÎ≥??®Ï? ?¨Ïù∏??Í≥ÑÏÇ∞
function calculateRemainingPoints() {
    const userType = '{{ session["user_type"] }}';
    const evaluationType = '{{ evaluation_type }}';
    
    // ?Ä?•Ïùò ?ÄÎ¶¨Ïù¥???âÍ????âÎ©¥ Î¶¨Ïä§?∏Ïù¥ÎØÄÎ°?Î≥ÑÎèÑ Ï≤òÎ¶¨
    if (userType === '?âÍ????Ä??' && evaluationType === 'manager') {
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 80;
        let usedPoints = 0;
        
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) return;
            usedPoints += parseInt(scoreEl.value);
        });
        
        const remainingPoints = totalPoints - usedPoints;
        const remainingElement = document.getElementById('remaining-points-manager');
        if (remainingElement) {
            remainingElement.textContent = remainingPoints;
            
            if (remainingPoints < 0) {
                remainingElement.className = 'text-danger fw-bold';
            } else if (remainingPoints === 0) {
                remainingElement.className = 'text-success fw-bold';
            } else {
                remainingElement.className = 'text-warning';
            }
        }
        return;
    }
    
    // ÏßÅÍ∏âÎ≥??∞Ïù¥?∞Î? JavaScript Í∞ùÏ≤¥Î°??ÑÎã¨
    const gradeGroups = {{ grade_groups|tojson }};
    
    Object.keys(gradeGroups).forEach(grade => {
        const gradeEvaluatees = gradeGroups[grade];
        let totalPoints = 0;
        
        if (userType === '?âÍ????Ä??') {
            if (evaluationType === 'employee') {
                totalPoints = gradeEvaluatees.length * 100; // ?àÎ??âÍ?
            } else if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 80;
            }
        } else if (userType === '?âÍ????ÑÏõê)') {
            if (evaluationType === 'team_leader') {
                totalPoints = gradeEvaluatees.length * 90;
            } else if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 5;
            } else if (evaluationType === 'general') {
                totalPoints = gradeEvaluatees.length * 85;
            }
        }
        
        let usedPoints = 0;
        gradeEvaluatees.forEach(evaluatee => {
            const score = parseInt(document.getElementById(`score-${evaluatee.id}`).value) || 0;
            usedPoints += score;
        });
        
        const remainingPoints = totalPoints - usedPoints;
        const remainingElement = document.getElementById(`remaining-points-${grade}`);
        if (remainingElement) {
            remainingElement.textContent = remainingPoints;
            
            if (remainingPoints < 0) {
                remainingElement.className = 'text-danger fw-bold';
            } else if (remainingPoints === 0) {
                remainingElement.className = 'text-success fw-bold';
            } else {
                remainingElement.className = 'text-warning';
            }
        }
    });
}

// ?¨Ïù∏???úÎèÑ Í≤ÄÏ¶??®Ïàò
function validatePointLimits(evaluationType) {
    const userType = '{{ session["user_type"] }}';
    
    // ?¨Ïù∏???úÎèÑ Í≤ÄÏ¶ùÏù¥ ?ÑÏöî??Í≤ΩÏö∞Îß??ïÏù∏
    if (evaluationType === 'general' && userType === '?âÍ????Ä??') {
        return true; // ?Ä???ºÎ∞òÏßÅÏ? ?òÍ≤¨Îß??ëÏÑ±?òÎ?Î°?Í≤ÄÏ¶?Î∂àÌïÑ??
    }
    
    const gradeGroups = {{ grade_groups|tojson }};
    
    for (const grade in gradeGroups) {
        const gradeEvaluatees = gradeGroups[grade];
        let totalPoints = 0;
        let minPoint = 0, maxPoint = 100;
        
        // ?âÍ? ?Ä?ÖÎ≥Ñ ?¨Ïù∏???úÎèÑ ?§Ï†ï
        if (userType === '?âÍ????Ä??') {
            if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 80;
                minPoint = 65;
                maxPoint = 95;
            }
        } else if (userType === '?âÍ????ÑÏõê)') {
            if (evaluationType === 'team_leader') {
                totalPoints = gradeEvaluatees.length * 90;
                minPoint = 75;
                maxPoint = 105;
            } else if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 5;
                minPoint = 0;
                maxPoint = 10;
            } else if (evaluationType === 'general') {
                totalPoints = gradeEvaluatees.length * 85;
                minPoint = 65;
                maxPoint = 105;
            }
        }
        
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        // Í∞??âÍ? ?Ä?ÅÏûê???êÏàò ?ïÏù∏
        for (const evaluatee of gradeEvaluatees) {
            const scoreElement = document.getElementById(`score-${evaluatee.id}`);
            if (!scoreElement) continue;
            
            const score = parseInt(scoreElement.value) || 0;
            
            // Í∞úÏù∏Î≥??êÏàò ?úÎèÑ Í≤ÄÏ¶?
            if (score < minPoint || score > maxPoint) {
                alert(`${evaluatee.name}???êÏàò??${minPoint}???¥ÏÉÅ ${maxPoint}???¥Ìïò?¨Ïïº ?©Îãà??`);
                hasInvalidScore = true;
                break;
            }
            
            usedPoints += score;
        }
        
        if (hasInvalidScore) return false;
        
        // ?ÑÏ≤¥ ?¨Ïù∏???úÎèÑ Í≤ÄÏ¶?
        if (usedPoints !== totalPoints) {
            alert(`${grade} ÏßÅÍ∏â??Ï¥??¨Ïù∏?∏Îäî ${totalPoints}?êÏù¥?¥Ïïº ?©Îãà?? (?ÑÏû¨: ${usedPoints}??`);
            return false;
        }
    }
    
    return true;
}

// ?âÍ? ?úÏ∂ú
function submitEvaluation(employeeId, evaluationType) {
    const userType = '{{ session["user_type"] }}';
    let scores = {};
    let comments = document.getElementById(`comments-${employeeId}`).value;
    
    if (evaluationType === 'employee') {
        // ?àÎ??âÍ? ?∞Ïù¥???òÏßë
        const radios = document.querySelectorAll(`input[name$="_${employeeId}"]:checked`);
        radios.forEach(radio => {
            scores[radio.name] = radio.value;
        });
    } else if (evaluationType === 'general' && userType === '?âÍ????Ä??') {
        // ?Ä???ºÎ∞òÏß? ?òÍ≤¨Îß??úÏ∂ú
        scores = {};
    } else {
        // ?ÅÎ??âÍ? ?∞Ïù¥???òÏßë (?ÑÏõê ?ºÎ∞òÏß??¨Ìï®)
        const score = document.getElementById(`score-${employeeId}`).value;
        if (!score) {
            alert('?âÍ? ?êÏàòÎ•??ÖÎ†•?¥Ï£º?∏Ïöî.');
            return;
        }
        
        // Í∞úÎ≥Ñ ?êÏàò ?úÎèÑ Í≤ÄÏ¶?
        const scoreInt = parseInt(score, 10);
        let minPoint = 0, maxPoint = 100;
        
        if (userType === '?âÍ????Ä??' && evaluationType === 'manager') {
            minPoint = 65;
            maxPoint = 95;
        } else if (userType === '?âÍ????ÑÏõê)') {
            if (evaluationType === 'team_leader') {
                minPoint = 75;
                maxPoint = 105;
            } else if (evaluationType === 'manager') {
                minPoint = 0;
                maxPoint = 10;
            } else if (evaluationType === 'general') {
                minPoint = 65;
                maxPoint = 105;
            }
        }
        
        if (scoreInt < minPoint || scoreInt > maxPoint) {
            alert(`?êÏàò??${minPoint}???¥ÏÉÅ ${maxPoint}???¥Ìïò?¨Ïïº ?©Îãà??`);
            return;
        }
        
        scores = { score: scoreInt };
    }
    
    const data = {
        evaluatee_id: employeeId,
        evaluation_type: evaluationType,
        scores: scores,
        comments: comments
    };
    
    fetch('/submit_evaluation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('?âÍ?Í∞Ä ?Ä?•Îêò?àÏäµ?àÎã§.');
        } else {
            alert('?§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§: ' + data.message);
        }
    });
}

// ÏßÅÍ∏âÎ≥???ï† ?ïÏùò ?ÑÏ≤¥ Î≥¥Í∏∞
function showJobRoleDefinitions() {
    // Î™®Îã¨ ?¥Ïö©???ÑÏ≤¥ ÏßÅÍ∏â ?ïÎ≥¥Î°??§Ï†ï
    document.getElementById('jobTitle').textContent = 'ÏßÅÍ∏âÎ≥???ï† ?ïÏùò';
    
    // ?®Í≤®Ïß??∞Ïù¥?∞Ïóê??ÏßÅÍ∏â ?ïÎ≥¥ Í∞Ä?∏Ïò§Í∏?
    const jobRoleItems = document.querySelectorAll('.job-role-item');
    let allJobInfo = '';
    
    jobRoleItems.forEach(item => {
        const title = item.getAttribute('data-title');
        const definition = item.getAttribute('data-definition');
        const guidelines = item.getAttribute('data-guidelines');
        
        allJobInfo += '<div class="mb-4 border-bottom pb-3">';
        allJobInfo += '<h5 class="text-primary mb-3"><i class="fas fa-user-tie me-2"></i>' + title + '</h5>';
        allJobInfo += '<div class="row">';
        allJobInfo += '<div class="col-md-6">';
        allJobInfo += '<h6 class="text-success mb-2"><i class="fas fa-bullseye me-1"></i>??ï† ?ïÏùò</h6>';
        allJobInfo += '<div class="border rounded p-3 mb-3 bg-light">';
        allJobInfo += '<p class="mb-0">' + definition + '</p>';
        allJobInfo += '</div>';
        allJobInfo += '</div>';
        allJobInfo += '<div class="col-md-6">';
        allJobInfo += '<h6 class="text-info mb-2"><i class="fas fa-list-check me-1"></i>?âÎèô ÏßÄÏπ?/h6>';
        allJobInfo += '<div class="border rounded p-3 bg-light">';
        
        // ?âÎèô ÏßÄÏπ®ÏùÑ Ï§ÑÎ∞îÍøàÏúºÎ°?Î∂ÑÎ¶¨
        const guidelineList = guidelines.split('\n');
        guidelineList.forEach(guideline => {
            if (guideline.trim()) {
                allJobInfo += '<p class="mb-1">' + guideline.trim() + '</p>';
            }
        });
        
        allJobInfo += '</div>';
        allJobInfo += '</div>';
        allJobInfo += '</div>';
        allJobInfo += '</div>';
    });
    
    document.getElementById('jobDefinition').innerHTML = allJobInfo;
    
    // Î™®Îã¨ ?úÏãú
    const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
    modal.show();
}

// ÏßÅÍ∏âÎ≥???ï† ?ïÏùò ?ÅÏÑ∏ ?ïÎ≥¥ ?úÏãú (Í∞úÎ≥Ñ ÏßÅÍ∏â)
function showJobDetail(jobTitle, jobDefinition, jobGuidelines) {
    document.getElementById('jobTitle').textContent = jobTitle;
    document.getElementById('jobDefinition').textContent = jobDefinition;
    
    // ?âÎèô ÏßÄÏπ®ÏùÑ Ï§ÑÎ∞îÍøàÏúºÎ°?Î∂ÑÎ¶¨?òÏó¨ Î¶¨Ïä§?∏Î°ú ?úÏãú
    const guidelines = jobGuidelines.split('\n').filter(line => line.trim() !== '');
    let guidelinesHtml = '';
    guidelines.forEach(guideline => {
        if (guideline.trim()) {
            guidelinesHtml += '<p class="mb-1">' + guideline.trim() + '</p>';
        }
    });
    document.getElementById('jobGuidelines').innerHTML = guidelinesHtml;
    
    // Î™®Îã¨ ?úÏãú
    const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
    modal.show();
}

// ?¥Î≤§??Î¶¨Ïä§???±Î°ù
document.addEventListener('DOMContentLoaded', function() {
    // ?àÎ??âÍ? ?ºÎîî??Î≤ÑÌäº ?¥Î≤§??
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            const employeeId = this.name.split('_').pop();
            calculateTotalScore(employeeId);
        });
    });
    
    // ?ÅÎ??âÍ? ?êÏàò ?ÖÎ†• ?¥Î≤§??
    const scoreInputs = document.querySelectorAll('.score-input');
    scoreInputs.forEach(input => {
        input.addEventListener('input', function() {
            calculateRemainingPoints();
        });
    });
    
    // Ï¥àÍ∏∞ ?¨Ïù∏??Í≥ÑÏÇ∞
    if ('{{ evaluation_type }}' !== 'general') {
        calculateRemainingPoints();
    }
});

// ?êÏàò Ï°∞Ï†ï ?®Ïàò (¬±15??
function adjustScore(employeeId, adjustment) {
    const scoreInput = document.getElementById(`score-${employeeId}`);
    if (!scoreInput) return;
    
    let currentScore = parseInt(scoreInput.value) || 0;
    let newScore = currentScore + adjustment;
    
    // ÏµúÏÜå/ÏµúÎ? ?êÏàò ?úÌïú
    const minScore = 65;
    const maxScore = 95;
    
    if (newScore < minScore) {
        newScore = minScore;
    } else if (newScore > maxScore) {
        newScore = maxScore;
    }
    
    scoreInput.value = newScore;
    calculateRemainingPoints(); // ?®Ï? ?¨Ïù∏???¨Í≥Ñ??
    checkScoreDifference(employeeId); // ?êÏàò Ï∞®Ïù¥ ?ïÏù∏
}

// ?êÏàò ?ÖÎ†• ??ÏßÅÏ†Ñ ?êÏàò ?ÄÎπ?Ï∞®Ïù¥ ?ïÏù∏
function checkScoreDifference(employeeId) {
    const scoreInput = document.getElementById(`score-${employeeId}`);
    if (!scoreInput) return;
    
    const currentScore = parseInt(scoreInput.value) || 0;
    const beforePoint = parseInt(scoreInput.getAttribute('data-before-point')) || 0;
    
    if (beforePoint > 0) {
        const difference = Math.abs(currentScore - beforePoint);
        if (difference >= 15) {
            // ?åÎ™Ö???ëÏÑ± ?àÎÇ¥ ?úÏãú
            const explanationDiv = document.getElementById(`explanation-${employeeId}`);
            if (explanationDiv) {
                explanationDiv.style.display = 'block';
                explanationDiv.innerHTML = `
                    <div class="alert alert-warning mt-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>?åÎ™Ö???ëÏÑ± ?ÑÏöî</strong><br>
                        ÏßÅÏ†Ñ ?êÏàò(${beforePoint}?? ?ÄÎπ?${difference}??Ï∞®Ïù¥Í∞Ä Î∞úÏÉù?àÏäµ?àÎã§.<br>
                        ?åÎ™Ö?úÎ? ?ëÏÑ±?¥Ï£º?∏Ïöî.<br>
                        <small class="text-muted">(?åÎ™Ö???ëÏãù?Ä ?∏ÏÇ¨Í∏∞Ìöç?Ä Î¨∏Ïàò???ÄÎ¶¨ÏóêÍ≤??îÏ≤≠)</small>
                    </div>
                `;
            }
        } else {
            // ?åÎ™Ö???àÎÇ¥ ?®Í∏∞Í∏?
            const explanationDiv = document.getElementById(`explanation-${employeeId}`);
            if (explanationDiv) {
                explanationDiv.style.display = 'none';
            }
        }
    }
}

function saveEvaluationsTemporary(evaluationType) {
    const userType = '{{ session["user_type"] }}';
    
    // ?Ä?•Ïùò Í≤ΩÏö∞ ?¨Ïù∏???úÎèÑ Í≤ÄÏ¶?Ï∂îÍ?
    if (userType === '?âÍ????Ä??' && evaluationType === 'manager') {
        // ?Ä?•Ï? ?ÑÏ≤¥ ?âÍ??êÏóê ?Ä???¨Ïù∏???úÎèÑ Í≤ÄÏ¶?
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 80;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 65 || score > 95) {
                alert(`?êÏàò??65???¥ÏÉÅ 95???¥Ìïò?¨Ïïº ?©Îãà?? (?ÑÏû¨: ${score}??`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`Ï¥??¨Ïù∏?∏Îäî ${totalPoints}?êÏù¥?¥Ïïº ?©Îãà?? (?ÑÏû¨: ${usedPoints}??`);
            return;
        }
    }
    
    // ?ÑÏõê???Ä???âÍ? ?úÎèÑ Í≤ÄÏ¶?Ï∂îÍ?
    if (userType === '?âÍ????ÑÏõê)' && evaluationType === 'team_leader') {
        // ?ÑÏõê?Ä ?ÑÏ≤¥ ?Ä?•Ïóê ?Ä???¨Ïù∏???úÎèÑ Í≤ÄÏ¶?
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 90;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 75 || score > 105) {
                alert(`?êÏàò??75???¥ÏÉÅ 105???¥Ìïò?¨Ïïº ?©Îãà?? (?ÑÏû¨: ${score}??`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`Ï¥??¨Ïù∏?∏Îäî ${totalPoints}?êÏù¥?¥Ïïº ?©Îãà?? (?ÑÏû¨: ${usedPoints}??`);
            return;
        }
    }
    
    // ?ÑÏõê???Ä???âÍ?(Í¥ÄÎ¶¨ÏßÅ) ?úÎèÑ Í≤ÄÏ¶?Ï∂îÍ?
    if (userType === '?âÍ????ÑÏõê)' && evaluationType === 'manager') {
        // ?ÑÏõê?Ä ?ÑÏ≤¥ Í¥ÄÎ¶¨ÏßÅ???Ä???¨Ïù∏???úÎèÑ Í≤ÄÏ¶?
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 5;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 0 || score > 10) {
                alert(`?êÏàò??0???¥ÏÉÅ 10???¥Ìïò?¨Ïïº ?©Îãà?? (?ÑÏû¨: ${score}??`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`Ï¥??¨Ïù∏?∏Îäî ${totalPoints}?êÏù¥?¥Ïïº ?©Îãà?? (?ÑÏû¨: ${usedPoints}??`);
            return;
        }
    }
    
    // ?ÑÏõê???Ä???âÍ?(?ºÎ∞òÏß? ?úÎèÑ Í≤ÄÏ¶?Ï∂îÍ?
    if (userType === '?âÍ????ÑÏõê)' && evaluationType === 'general') {
        // ?ÑÏõê?Ä ?ÑÏ≤¥ ?ºÎ∞òÏßÅÏóê ?Ä???¨Ïù∏???úÎèÑ Í≤ÄÏ¶?
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 85;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 65 || score > 105) {
                alert(`?êÏàò??65???¥ÏÉÅ 105???¥Ìïò?¨Ïïº ?©Îãà?? (?ÑÏû¨: ${score}??`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`Ï¥??¨Ïù∏?∏Îäî ${totalPoints}?êÏù¥?¥Ïïº ?©Îãà?? (?ÑÏû¨: ${usedPoints}??`);
            return;
        }
    }
    
    // ?âÍ????Ä????Í∞úÎ≥Ñ ?ÑÏãú?Ä?? ?âÍ????ÑÏõê)???ºÍ¥Ñ ?ÑÏãú?Ä??
    if (userType === '?âÍ????Ä??') {
        // Í∞úÎ≥Ñ ?ÑÏãú?Ä??
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let savedCount = 0;
        let totalCount = 0;
        
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            const commentsEl = document.getElementById(`comments-${eid}`);
            const scoreVal = scoreEl ? scoreEl.value : '';
            const commentsVal = commentsEl ? commentsEl.value : '';
            
            totalCount++;
            
            fetch('/submit_evaluation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    evaluatee_id: eid,
                    evaluation_type: evaluationType,
                    scores: { score: scoreVal ? parseInt(scoreVal, 10) : 0 },
                    comments: commentsVal || ''
                })
            }).then(r => r.json()).then(res => {
                savedCount++;
                if (res.success) {
                    if (savedCount === totalCount) {
                        alert(`Ï¥?${savedCount}Í±¥Ïùò ?âÍ?Í∞Ä ?ÑÏãú?Ä?•Îêò?àÏäµ?àÎã§.`);
                    }
                } else {
                    alert(res.message || '?ÑÏãú?Ä??Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.');
                }
            }).catch(err => {
                alert('?ÑÏãú?Ä??Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.');
                console.error(err);
            });
        });
        
        if (totalCount === 0) {
            alert('?ÑÏãú?Ä?•Ìï† ?âÍ?Í∞Ä ?ÜÏäµ?àÎã§.');
        }
    } else {
        // ?ÑÏõê??Í≤ΩÏö∞ ?ºÍ¥Ñ ?ÑÏãú?Ä??
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        const evaluations = [];
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            const commentsEl = document.getElementById(`comments-${eid}`);
            const scoreVal = scoreEl ? scoreEl.value : '';
            const commentsVal = commentsEl ? commentsEl.value : '';
            
            evaluations.push({
                evaluatee_id: eid,
                scores: { score: scoreVal ? parseInt(scoreVal, 10) : 0 },
                comments: commentsVal || ''
            });
        });
        
        if (evaluations.length === 0) {
            alert('?ÑÏãú?Ä?•Ìï† ?âÍ?Í∞Ä ?ÜÏäµ?àÎã§.');
            return;
        }
        
        fetch('/submit_evaluations_bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ evaluation_type: evaluationType, evaluations })
        }).then(r => r.json()).then(res => {
            if (res.success) {
                alert(`Ï¥?${res.count}Í±¥Ïùò ?âÍ?Í∞Ä ?ÑÏãú?Ä?•Îêò?àÏäµ?àÎã§.`);
            } else {
                alert(res.message || '?ÑÏãú?Ä??Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.');
            }
        });
    }
}

function submitEvaluationsBulk(evaluationType) {
    const userType = '{{ session["user_type"] }}';
    
    // ?Ä?•Ïùò Í≤ΩÏö∞ ?¨Ïù∏???úÎèÑ Í≤ÄÏ¶?Î∞©Ïãù???§Î¶Ñ (?âÎ©¥ Î¶¨Ïä§??
    if (userType === '?âÍ????Ä??' && evaluationType === 'manager') {
        // ?Ä?•Ï? ?ÑÏ≤¥ ?âÍ??êÏóê ?Ä???¨Ïù∏???úÎèÑ Í≤ÄÏ¶?
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 80;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 65 || score > 95) {
                alert(`?êÏàò??65???¥ÏÉÅ 95???¥Ìïò?¨Ïïº ?©Îãà?? (?ÑÏû¨: ${score}??`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`Ï¥??¨Ïù∏?∏Îäî ${totalPoints}?êÏù¥?¥Ïïº ?©Îãà?? (?ÑÏû¨: ${usedPoints}??`);
            return;
        }
    } else {
        // ?ÑÏõê??Í≤ΩÏö∞ Í∏∞Ï°¥ Í≤ÄÏ¶?Î∞©Ïãù ?¨Ïö©
        if (!validatePointLimits(evaluationType)) {
            return; // Í≤ÄÏ¶??§Ìå® ???úÏ∂ú Ï§ëÎã®
        }
    }
    
    // ?âÍ????Ä????Í∞úÎ≥Ñ ?úÏ∂ú, ?âÍ????ÑÏõê)???ºÍ¥Ñ ?úÏ∂ú
    if (userType === '?âÍ????Ä??') {
        // Í∞úÎ≥Ñ ?úÏ∂ú
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let submittedCount = 0;
        let totalCount = 0;
        
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            const commentsEl = document.getElementById(`comments-${eid}`);
            const scoreVal = scoreEl ? scoreEl.value : '';
            const commentsVal = commentsEl ? commentsEl.value : '';
            if (scoreVal === '') return; // ?êÏàò ?ÜÎäî ??™©?Ä ?úÏô∏
            
            totalCount++;
            
            fetch('/submit_evaluation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    evaluatee_id: eid,
                    evaluation_type: evaluationType,
                    scores: { score: parseInt(scoreVal, 10) },
                    comments: commentsVal || ''
                })
            }).then(r => r.json()).then(res => {
                submittedCount++;
                if (res.success) {
                    if (submittedCount === totalCount) {
                        alert(`Ï¥?${submittedCount}Í±¥Ïùò ?âÍ?Í∞Ä ?úÏ∂ú?òÏóà?µÎãà??`);
                    }
                } else {
                    alert(res.message || '?úÏ∂ú Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.');
                }
            }).catch(err => {
                alert('?úÏ∂ú Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.');
                console.error(err);
            });
        });
        
        if (totalCount === 0) {
            alert('?úÏ∂ú???âÍ?Í∞Ä ?ÜÏäµ?àÎã§. ?êÏàòÎ•??ÖÎ†•?òÏÑ∏??');
        }
    } else {
        // ?ÑÏõê??Í≤ΩÏö∞ ?ºÍ¥Ñ ?úÏ∂ú
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        const evaluations = [];
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            const commentsEl = document.getElementById(`comments-${eid}`);
            const scoreVal = scoreEl ? scoreEl.value : '';
            const commentsVal = commentsEl ? commentsEl.value : '';
            if (scoreVal === '') return; // ?êÏàò ?ÜÎäî ??™©?Ä ?úÏô∏
            evaluations.push({
                evaluatee_id: eid,
                scores: { score: parseInt(scoreVal, 10) },
                comments: commentsVal || ''
            });
        });
        if (evaluations.length === 0) {
            alert('?úÏ∂ú???âÍ?Í∞Ä ?ÜÏäµ?àÎã§. ?êÏàòÎ•??ÖÎ†•?òÏÑ∏??');
            return;
        }
        fetch('/submit_evaluations_bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ evaluation_type: evaluationType, evaluations })
        }).then(r => r.json()).then(res => {
            if (res.success) {
                alert(`Ï¥?${res.count}Í±¥Ïùò ?âÍ?Í∞Ä ?úÏ∂ú?òÏóà?µÎãà??`);
            } else {
                alert(res.message || '?úÏ∂ú Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.');
            }
        });
    }
}

// ?òÏù¥ÏßÄ Î°úÎìú ??Ï¥àÍ∏∞??
document.addEventListener('DOMContentLoaded', function() {
    // ?âÍ????ÑÏõê)???Ä???âÍ?(Í¥ÄÎ¶¨ÏßÅ)?êÏÑú Ï¥àÍ∏∞ ?©Í≥Ñ ?êÏàò ?úÏãú
    const userType = '{{ session["user_type"] }}';
    const evaluationType = '{{ evaluation_type }}';
    
    if (userType === '?âÍ????ÑÏõê)' && evaluationType === 'manager') {
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (eid) {
                updateTotalScore(eid);
            }
        });
    }
});
</script>
{% endblock %} 
