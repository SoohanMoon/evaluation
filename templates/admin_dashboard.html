{% extends "base.html" %}

{% block title %}관리자 대시보드 - DK 동국홀딩스 인사평가 시스템{% endblock %}

{% block extra_css %}
<style>
.dashboard-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    padding: 20px 0;
    margin-bottom: 30px;
}

.user-profile-card {
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
}

.kpi-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
    border: none;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.kpi-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.kpi-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.kpi-label {
    font-size: 1rem;
    color: #666;
    font-weight: 500;
}

.status-table {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.management-panel {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.management-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px 20px;
    margin: 5px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.management-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    color: white;
}

.alerts-panel {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-top: 30px;
}

.alert-item {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.table-modern {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.table-modern thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.table-modern tbody tr:hover {
    background-color: #f8f9ff;
}
</style>
{% endblock %}

{% block content %}
<!-- 대시보드 헤더 -->
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>DK 동국홀딩스 인사평가 시스템
                </h2>
                <p class="mb-0 mt-2" style="color: rgba(255,255,255,0.9);">관리자 대시보드</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-2"></i>{{ user_data.name }}
                        <i class="fas fa-chevron-down ms-1"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2"></i>로그아웃</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- 사용자 프로필 카드 -->
    <div class="user-profile-card">
        <div class="row">
            <div class="col-md-3">
                <h6><i class="fas fa-user me-2"></i>이름</h6>
                <p class="mb-0 fs-5 fw-bold">{{ user_data.name }}</p>
            </div>
            <div class="col-md-3">
                <h6><i class="fas fa-building me-2"></i>소속</h6>
                <p class="mb-0 fs-5 fw-bold">{{ user_data.team }}</p>
            </div>
            <div class="col-md-3">
                <h6><i class="fas fa-id-badge me-2"></i>직위</h6>
                <p class="mb-0 fs-5 fw-bold">{{ user_data.position }}</p>
            </div>
            <div class="col-md-3">
                <h6><i class="fas fa-star me-2"></i>직급</h6>
                <p class="mb-0 fs-5 fw-bold">{{ user_data.grade }}</p>
            </div>
        </div>
    </div>

<div class="row mt-3">
    <div class="col-12">
        <div class="d-flex justify-content-end gap-2">
            <a href="{{ url_for('download_excel') }}" class="btn btn-success">
                <i class="fas fa-file-excel me-1"></i>엑셀 다운로드
            </a>
            <a href="{{ url_for('reset_evaluations') }}" class="btn btn-warning" 
               onclick="return confirm('정말로 모든 평가 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')">
                <i class="fas fa-trash-alt me-1"></i>데이터 초기화
            </a>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>전체 평가 결과 조회
                </h5>
            </div>
            <div class="card-body">
                {% if evaluator_stats %}
                    {% for evaluator_id, evaluator_data in evaluator_stats.items() %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-user-tie me-2"></i>
                                평가자: {{ evaluator_data.info.name }} ({{ evaluator_id }}) - {{ evaluator_data.info.team }} {{ evaluator_data.info.position }}
                            </h6>
                            <a href="{{ url_for('reset_evaluator', evaluator_id=evaluator_id) }}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('정말로 이 평가자의 모든 평가 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')">
                                <i class="fas fa-trash-alt me-1"></i>초기화
                            </a>
                        </div>
                        
                        {% for eval_type, evaluations in evaluator_data.evaluations.items() %}
                        <div class="mb-3">
                            <h6 class="text-secondary">
                                {% if eval_type == "employee" %}
                                    <span class="badge bg-primary me-2">사원 평가</span>
                                {% elif eval_type == "manager" %}
                                    <span class="badge bg-success me-2">관리직 평가</span>
                                {% elif eval_type == "general" %}
                                    <span class="badge bg-info me-2">일반직 평가</span>
                                {% elif eval_type == "team_leader" %}
                                    <span class="badge bg-warning me-2">팀장 평가</span>
                                {% else %}
                                    <span class="badge bg-secondary me-2">{{ eval_type }}</span>
                                {% endif %}
                            </h6>
                            
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>피평가자</th>
                                            <th>평가 점수</th>
                                            <th>평가일시</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for evaluation in evaluations %}
                                        <tr>
                                            <td>
                                                <strong>{{ evaluation.evaluatee_name }}</strong><br>
                                                <small class="text-muted">{{ evaluation.evaluatee_id }}</small>
                                            </td>
                                            <td>
                                                {% if evaluation.scores %}
                                                    {% if eval_type == "employee" %}
                                                        <!-- 사원 평가는 합계만 표시 -->
                                                        <span class="badge bg-primary me-1">합계: {{ evaluation.scores }}</span>
                                                    {% else %}
                                                        <!-- 다른 평가는 전체 점수 표시 -->
                                                        <span class="badge bg-primary me-1">점수: {{ evaluation.scores }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">점수 없음</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small>{{ evaluation.created_at }}</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <hr>
                    {% endfor %}
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    아직 평가 데이터가 없습니다.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 실적 데이터 섹션 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>피평가자 실적 데이터 조회
                </h5>
            </div>
            <div class="card-body">
                {% if performance_stats %}
                    {% for employee_id, employee_data in performance_stats.items() %}
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-user me-2"></i>
                                피평가자: {{ employee_data.info.name }} ({{ employee_id }}) - {{ employee_data.info.team }} {{ employee_data.info.position }}
                            </h6>
                            <a href="{{ url_for('reset_performance', employee_id=employee_id) }}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('정말로 이 피평가자의 모든 실적 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')">
                                <i class="fas fa-trash-alt me-1"></i>실적 초기화
                            </a>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>순서</th>
                                        <th>과제명</th>
                                        <th>실적 내용</th>
                                        <th>등록일시</th>
                                        <th>상태</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for performance in employee_data.performances %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">{{ performance.order }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ performance.project_name }}</strong>
                                        </td>
                                        <td>
                                            <div class="comment-box">
                                                {{ performance.performance }}
                                            </div>
                                        </td>
                                        <td>
                                            <small>{{ performance.created_at }}</small>
                                        </td>
                                        <td>
                                            {% if performance.is_finalized %}
                                                <span class="badge bg-success">최종등록</span>
                                            {% else %}
                                                <span class="badge bg-warning">임시저장</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <hr>
                    {% endfor %}
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    아직 실적 데이터가 없습니다.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-light">
            <h6><i class="fas fa-info-circle me-2"></i>관리자 안내</h6>
            <ul class="mb-0">
                <li>위 표에서 각 평가자가 피평가자들을 몇 점으로 평가했는지 확인할 수 있습니다.</li>
                <li>평가 코멘트도 함께 조회할 수 있습니다.</li>
                <li>평가 유형별로 색상이 구분되어 있습니다.</li>
                <li>평가자별로 그룹화되어 표시됩니다.</li>
                <li>피평가자별 실적 데이터도 조회하고 초기화할 수 있습니다.</li>
            </ul>
        </div>
    </div>
</div>

<style>
.comment-box {
    background-color: #f8f9fa;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    font-size: 0.9em;
}
</style>
{% endblock %}
