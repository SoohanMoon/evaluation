{% extends "base.html" %}

{% block title %}평가 - {{ evaluation_type }}{% endblock %}

{% block extra_css %}
<style>
.evaluation-card {
    border: 2px solid #1a1a2e;
    border-radius: 15px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.evaluation-card:hover {
    border-color: #16213e;
    box-shadow: 0 4px 8px rgba(22, 33, 62, 0.1);
}

.evaluation-card.selected {
    border-color: #16213e;
    background-color: #f8f9ff;
}

.score-input {
    width: 100px;
    text-align: center;
    border-radius: 8px;
    border: 2px solid #1a1a2e;
    padding: 8px;
    font-weight: bold;
    font-size: 14px;
}

.score-input:focus {
    border-color: #16213e;
    box-shadow: 0 0 0 0.2rem rgba(22, 33, 62, 0.25);
}

.absolute-evaluation {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1a1a2e;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #90caf9;
}

.relative-evaluation {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.criteria-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.performance-view {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #16213e;
}

/* 최종 제출 버튼 스타일 */
.btn-final-submit {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    font-weight: bold;
}

.btn-final-submit:hover {
    background-color: #c82333;
    border-color: #bd2130;
    color: white;
}

/* 임시저장 버튼 스타일 */
.btn-temp-save {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-temp-save:hover {
    background-color: #5a6268;
    border-color: #545b62;
    color: white;
}

/* 실적 조회 버튼 스타일 */
.btn-performance-view {
    background-color: #16213e;
    border-color: #16213e;
    color: white;
}

.btn-performance-view:hover {
    background-color: #1a1a2e;
    border-color: #1a1a2e;
    color: white;
}

/* 포인트 한도 알림 스타일 */
.alert-info {
    background-color: #e3f2fd;
    border-color: #16213e;
    color: #1a1a2e;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #16213e;
    color: #1a1a2e;
}

/* 소명서 경고 스타일 */
.alert-warning .alert-warning {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="user-info">
    <div class="row">
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>평가자</h6>
            <p class="mb-0">{{ user_data.name }}</p>
        </div>
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>소속</h6>
            <p class="mb-0">{{ user_data.team }}</p>
        </div>
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>평가 유형</h6>
                            <p class="mb-0">
                    {% if evaluation_type == 'employee' %}팀원 평가(사원)
                    {% elif evaluation_type == 'manager' and session['user_type'] == '평가자(팀장)' %}팀원 평가(대리 이상)
                    {% elif evaluation_type == 'manager' and session['user_type'] == '평가자(임원)' %}팀원 평가(관리직)
                    {% elif evaluation_type == 'general' %}팀원 평가(일반직)
                    {% elif evaluation_type == 'team_leader' %}팀장 평가
                    {% endif %}
                </p>
        </div>
        <div class="col-md-3">
            <h6><i class="fas fa-square me-2"></i>평가 대상</h6>
            <p class="mb-0">{{ evaluatees|length }}명</p>
        </div>
    </div>
</div>

{% if evaluation_type == 'employee' %}
<div class="absolute-evaluation">
    <h5><i class="fas fa-star me-2"></i>절대평가 안내</h5>
    <ul class="mb-0">
        <li>S(10점), A(8점), B(6점), C(4점), D(2점) 등급별 평가</li>
        <li>직급 체류기간 평균 점수가 60점 미만이면 대리 승진 제외</li>
        <li>각 평가 항목별로 등급을 선택하세요</li>
    </ul>
</div>
{% elif evaluation_type == 'general' %}
<div class="alert alert-info">
    <h5><i class="fas fa-comment me-2"></i>일반직 평가 안내</h5>
    {% if session['user_type'] == '평가자(팀장)' %}
    <p class="mb-0">일반직 평가는 평가 의견만 작성하시면 됩니다. 점수 입력은 필요하지 않습니다.</p>
    {% elif session['user_type'] == '평가자(임원)' %}
        {% if evaluation_type == 'team_leader' %}
    <p class="mb-0">상대평가: 인원수 × 90 포인트, 인당 최소 75점, 최대 105점</p>
        {% elif evaluation_type == 'general' %}
    <p class="mb-0">상대평가: 인원수 × 85 포인트, 인당 최소 65점, 최대 105점</p>
        {% elif evaluation_type == 'manager' %}
    <p class="mb-0">상대평가: 인원수 × 5 포인트, 인당 최소 0점, 최대 10점</p>
        {% endif %}
    {% endif %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        {% if evaluation_type == 'employee' %}
        <!-- 절대평가 폼 -->
        {% for grade, grade_evaluatees in grade_groups.items() %}
        <div class="grade-group mb-4">
            <h6 class="text-primary mb-3">{{ grade }} 직급 ({{ grade_evaluatees|length }}명)</h6>
            
            {% for evaluatee in grade_evaluatees %}
            <div class="evaluation-card" id="evaluatee-{{ evaluatee.id }}">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>{{ evaluatee.name }}
                            </h6>
                            <small class="text-dark">{{ evaluatee.team }} | {{ evaluatee.position }} | {{ evaluatee.grade }}</small>
                        </div>
                        <div class="col-md-6 text-end">
                            {% if evaluatee.before_point %}
                            <span class="badge bg-info">직전 평가: {{ evaluatee.before_point }}점</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- 실적 조회 -->
                    <div class="performance-view">
                        <h6><i class="fas fa-file-alt me-2"></i>작성된 실적</h6>
                        <div id="performance-{{ evaluatee.id|string }}">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPerformance('{{ evaluatee.id|string }}')">
                                <i class="fas fa-eye me-1"></i>실적 조회
                            </button>
                        </div>
                    </div>
                    
                    <!-- 절대평가 -->
                    <div class="absolute-evaluation-form">
                        <h6><i class="fas fa-star me-2"></i>절대평가</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>평가 항목</th>
                                        <th>S(10점)</th>
                                        <th>A(8점)</th>
                                        <th>B(6점)</th>
                                        <th>C(4점)</th>
                                        <th>D(2점)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>근무태도 - 근무시간 준수 및 업무 집중</td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>근무태도 - 직장 내 예의범절 준수</td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>근무태도 - 책임감 있는 업무 수행</td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="attitude_3_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>팔로워십 - 주어진 역할 적극 수용</td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>팔로워십 - 팀 목표 달성 지원 및 협력</td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>팔로워십 - 조직 가치와 문화 이해 및 적응</td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="followership_3_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>업무수행 능력 - 업무 내용 이해 및 정확한 수행</td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>업무수행 능력 - 기한 내 업무 완료</td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="performance_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>성장 마인드셋 - 새로운 지식 습득 및 활용</td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_1_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                    <tr>
                                        <td>성장 마인드셋 - 피드백 수용 및 자기계발 지속</td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="10" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="8" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="6" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="4" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                        <td><input type="radio" name="growth_2_{{ evaluatee.id }}" value="2" class="form-check-input" onchange="calculateTotalScore('{{ evaluatee.id }}')"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end">
                            <strong>총점: <span id="total-score-{{ evaluatee.id }}">0</span>/100점</strong>
                        </div>
                    </div>
                    
                    <!-- 평가 의견 -->
                    <div class="mt-3">
                        <label class="form-label">평가 의견</label>
                        <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" 
                                  placeholder="평가 의견을 작성하세요..."></textarea>
                    </div>
                    
                    <div class="mt-3 text-end">
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        
        <!-- 절대평가 임시저장/최종제출 버튼 -->
        <div class="d-flex gap-2 mt-4">
            <button type="button" class="btn btn-sm btn-temp-save" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                <i class="fas fa-save me-1"></i>임시저장
            </button>
            <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                <i class="fas fa-paper-plane me-1"></i>최종 제출
            </button>
        </div>
        
        {% elif evaluation_type in ['manager', 'team_leader'] %}
        <!-- 상대평가 폼 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>상대평가
                </h5>
                {% if (session['user_type'] == '평가자(임원)' and evaluation_type in ['manager', 'team_leader']) or (session['user_type'] == '평가자(팀장)' and evaluation_type == 'manager') %}
                <div>
                    <button type="button" class="btn btn-sm btn-temp-save me-2" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                        <i class="fas fa-save me-1"></i>임시저장
                    </button>
                    <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                        <i class="fas fa-paper-plane me-1"></i>최종 제출
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if session['user_type'] == '평가자(임원)' %}
                {# 임원은 직급별 그룹 #}
                {% for grade, grade_evaluatees in grade_groups.items() %}
                <div class="grade-group mb-4">
                    <h6 class="text-primary mb-3">{{ grade }} 직급 ({{ grade_evaluatees|length }}명)</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>포인트 한도:</strong> 
                                {% if evaluation_type == 'team_leader' %}
                                    인원수 × 90 포인트, 인당 최대 105점, 최소 75점
                                {% elif evaluation_type == 'manager' %}
                                    인원수 × 5 포인트, 인당 최대 10점, 최소 0점
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <strong>남은 포인트:</strong> <span id="remaining-points-{{ grade }}">-</span>
                            </div>
                        </div>
                    </div>
                    
                    {% for evaluatee in grade_evaluatees %}
                    <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 class="mb-1">{{ evaluatee.name }}</h6>
                                <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                                {% if evaluation_type == 'manager' and evaluatee.before_point %}
                                <div class="mt-1">
                                    <small class="text-info">팀장 평가: {{ evaluatee.before_point }}점</small>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">평가 점수</label>
                                        <input type="number" class="form-control score-input" id="score-{{ evaluatee.id }}" 
                                               min="0" max="105" step="1" placeholder="점수 입력"
                                               {% if evaluation_type == 'manager' %}data-before-point="{{ evaluatee.before_point or 0 }}" oninput="updateTotalScore('{{ evaluatee.id }}')"{% endif %}>
                                        {% if evaluation_type == 'manager' %}
                                        <div id="total-score-{{ evaluatee.id }}" class="mt-1">
                                            <small class="text-success"><strong>합계: <span id="total-{{ evaluatee.id }}">0</span>점</strong></small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-sm btn-performance-view" onclick="loadPerformance('{{ evaluatee.id }}')">
                                    <i class="fas fa-eye me-1"></i>실적 조회
                                </button>
                            </div>
                        </div>
                        <!-- 실적 표시 영역 추가 -->
                        <div id="performance-{{ evaluatee.id }}" class="mt-3"></div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">평가 의견</label>
                                <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="평가 의견을 작성해주세요"></textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                {% else %}
                {# 팀장은 평면 리스트 #}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <strong>포인트 한도:</strong> 인원수 × 80 포인트, 인당 한도 65~95점
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <strong>남은 포인트:</strong> <span id="remaining-points-manager">{{ evaluatees|length * 80 }}</span>
                        </div>
                    </div>
                </div>
                {% for evaluatee in evaluatees %}
                <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ evaluatee.name }}</h6>
                            <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                            {% if evaluatee.before_point %}
                            <div class="mt-1">
                                <small class="text-info">직전 점수: {{ evaluatee.before_point }}점</small>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">평가 점수</label>
                                    <input type="number" class="form-control score-input" id="score-{{ evaluatee.id }}" 
                                           min="65" max="95" step="1" placeholder="점수 입력"
                                           data-before-point="{{ evaluatee.before_point or 0 }}"
                                           oninput="checkScoreDifference('{{ evaluatee.id }}')">
                                    <div id="explanation-{{ evaluatee.id }}" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPerformance('{{ evaluatee.id|string }}')">
                                <i class="fas fa-eye me-1"></i>실적 조회
                            </button>
                        </div>
                    </div>
                    <!-- 실적 표시 영역 추가 -->
                    <div id="performance-{{ evaluatee.id|string }}" class="mt-3"></div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">평가 의견</label>
                            <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="평가 의견을 작성해주세요"></textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% elif evaluation_type == 'general' %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comment me-2"></i>일반직 평가</h5>
                {% if session['user_type'] == '평가자(임원)' %}
                <div>
                    <button type="button" class="btn btn-sm btn-temp-save me-2" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                        <i class="fas fa-save me-1"></i>임시저장
                    </button>
                    <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                        <i class="fas fa-paper-plane me-1"></i>최종 제출
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if session['user_type'] == '평가자(팀장)' %}
                <div class="alert alert-info mb-3">일반직 평가는 평가 의견만 작성하시면 됩니다.</div>
                {% for evaluatee in evaluatees %}
                <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ evaluatee.name }}</h6>
                            <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                        </div>
                        <div class="col-md-8 text-end">
                            <button type="button" class="btn btn-sm btn-performance-view" onclick="loadPerformance('{{ evaluatee.id|string }}')">
                                <i class="fas fa-eye me-1"></i>실적 조회
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">평가 의견</label>
                            <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="평가 의견을 작성해주세요"></textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-sm btn-temp-save" onclick="saveEvaluationsTemporary('{{ evaluation_type }}')">
                        <i class="fas fa-save me-1"></i>임시저장
                    </button>
                    <button type="button" class="btn btn-sm btn-final-submit" onclick="submitEvaluationsBulk('{{ evaluation_type }}')">
                        <i class="fas fa-paper-plane me-1"></i>최종 제출
                    </button>
                </div>
                {% elif session['user_type'] == '평가자(임원)' %}
                {% for grade, grade_evaluatees in grade_groups.items() %}
                <div class="grade-group mb-4">
                    <h6 class="text-primary mb-3">{{ grade }} 직급 ({{ grade_evaluatees|length }}명)</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="alert alert-info"><strong>포인트 한도:</strong> 총 {{ grade_evaluatees|length * 85 }}점</div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning"><strong>남은 포인트:</strong> <span id="remaining-points-{{ grade }}">-</span></div>
                        </div>
                    </div>
                    {% for evaluatee in grade_evaluatees %}
                    <div class="evaluatee-item border rounded p-3 mb-3" data-eid="{{ evaluatee.id }}">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 class="mb-1">{{ evaluatee.name }}</h6>
                                <small class="text-muted">{{ evaluatee.team }} | {{ evaluatee.position }}</small>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">평가 점수</label>
                                        <input type="number" class="form-control score-input" id="score-{{ evaluatee.id }}" min="65" max="105" step="1" placeholder="점수 입력">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-sm btn-performance-view" onclick="loadPerformance('{{ evaluatee.id }}')">
                                    <i class="fas fa-eye me-1"></i>실적 조회
                                </button>
                            </div>
                        </div>
                        <!-- 실적 표시 영역 추가 -->
                        <div id="performance-{{ evaluatee.id }}" class="mt-3"></div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">평가 의견</label>
                                <textarea class="form-control" id="comments-{{ evaluatee.id }}" rows="3" placeholder="평가 의견을 작성해주세요"></textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    {% if evaluation_type != 'general' %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>직급별 역할 정의
                </h5>
            </div>
            <div class="card-body text-center">
                {% if jikkeup is not none and not jikkeup.empty %}
                <button type="button" class="btn btn-primary btn-lg" onclick="showJobRoleDefinitions()">
                    <i class="fas fa-eye me-2"></i>직급별 역할 정의 보기
                </button>
                <p class="text-muted mt-2 small">클릭하여 각 직급의 역할 정의와 행동 지침을 확인하세요</p>
                
                <!-- 숨겨진 직급별 역할 정의 데이터 -->
                <div id="job-role-data" style="display: none;">
                    {% for _, row in jikkeup.iterrows() %}
                    <div class="job-role-item" 
                         data-title="{{ row.iloc[0] }}" 
                         data-definition="{{ row.iloc[2] }}" 
                         data-guidelines="{{ row.iloc[3] }}">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">직급별 역할 정의를 불러올 수 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- 직급별 역할 정의 상세 모달 -->
<div class="modal fade" id="jobDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book me-2"></i><span id="jobTitle"></span> 역할 정의
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jobDefinition"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 합계 점수 업데이트 함수 (평가자(임원) 팀원 평가(관리직)용)
function updateTotalScore(evaluateeId) {
    const scoreInput = document.getElementById(`score-${evaluateeId}`);
    const totalSpan = document.getElementById(`total-${evaluateeId}`);
    
    if (!scoreInput || !totalSpan) return;
    
    const currentScore = parseInt(scoreInput.value) || 0;
    const beforePoint = parseInt(scoreInput.getAttribute('data-before-point')) || 0;
    
    // 팀장 평가 점수 + 현재 평가 점수 = 합계
    const totalScore = beforePoint + currentScore;
    
    totalSpan.textContent = totalScore;
    
    // 합계 점수에 따른 색상 변경
    const totalScoreDiv = document.getElementById(`total-score-${evaluateeId}`);
    if (totalScoreDiv) {
        const totalElement = totalScoreDiv.querySelector('small');
        if (totalElement) {
            if (totalScore >= 90) {
                totalElement.className = 'text-success fw-bold';
            } else if (totalScore >= 80) {
                totalElement.className = 'text-primary fw-bold';
            } else if (totalScore >= 70) {
                totalElement.className = 'text-warning fw-bold';
            } else {
                totalElement.className = 'text-danger fw-bold';
            }
        }
    }
}

// 실적 조회
function loadPerformance(employeeId) {
    console.log('실적 조회 시작:', employeeId);
    
    // 모든 가능한 ID 형식 시도
    const possibleIds = [
        'performance-' + employeeId,
        'performance-' + String(employeeId),
        'performance-' + employeeId.toString()
    ];
    
    let container = null;
    for (const id of possibleIds) {
        container = document.getElementById(id);
        if (container) {
            console.log('찾은 컨테이너 ID:', id);
            break;
        }
    }
    
    if (!container) {
        console.error('컨테이너를 찾을 수 없습니다. 시도한 ID들:', possibleIds);
        // 페이지의 모든 div 요소 출력
        const allDivs = document.querySelectorAll('div[id^="performance-"]');
        console.log('페이지의 performance-로 시작하는 모든 div:', allDivs);
        return;
    }
    
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> 로딩 중...</div>';
    
    fetch('/get_performance/' + employeeId)
        .then(response => response.json())
        .then(data => {
            console.log('받은 데이터:', data);
            
            if (data.success && data.data && data.data.length > 0) {
                let html = '<div class="alert alert-info">';
                data.data.forEach((perf, index) => {
                    if (index > 0) html += '<div class="border-top pt-3 mb-3"></div>';
                    html += '<h6 class="mb-2"><i class="fas fa-list-ol me-1"></i>실적 ' + perf.order + '</h6>';
                    html += '<p class="mb-1"><strong>과제명:</strong> ' + perf.project_name + '</p>';
                    html += '<p class="mb-2" style="white-space: pre-line;">' + perf.performance + '</p>';
                    html += '<small class="text-muted">작성일: ' + perf.created_at + '</small>';
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-1"></i>실적 데이터가 없습니다.</div>';
            }
        })
        .catch(error => {
            console.error('실적 조회 오류:', error);
            container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>실적 조회 중 오류가 발생했습니다.</div>';
        });
}

// 절대평가 총점 계산
function calculateTotalScore(employeeId) {
    const radios = document.querySelectorAll(`input[name$="_${employeeId}"]:checked`);
    let total = 0;
    radios.forEach(radio => {
        total += parseInt(radio.value);
    });
    document.getElementById(`total-score-${employeeId}`).textContent = total;
}

// 상대평가 점수 차이 계산 (제거됨 - 팀장 평가 대비 기능 제거)
function calculateScoreDiff(employeeId) {
    // 이 함수는 더 이상 사용되지 않습니다
    // 팀장 평가 대비 기능이 제거되었습니다
}

// 직급별 남은 포인트 계산
function calculateRemainingPoints() {
    const userType = '{{ session["user_type"] }}';
    const evaluationType = '{{ evaluation_type }}';
    
    // 팀장의 대리이상 평가는 평면 리스트이므로 별도 처리
    if (userType === '평가자(팀장)' && evaluationType === 'manager') {
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 80;
        let usedPoints = 0;
        
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) return;
            usedPoints += parseInt(scoreEl.value);
        });
        
        const remainingPoints = totalPoints - usedPoints;
        const remainingElement = document.getElementById('remaining-points-manager');
        if (remainingElement) {
            remainingElement.textContent = remainingPoints;
            
            if (remainingPoints < 0) {
                remainingElement.className = 'text-danger fw-bold';
            } else if (remainingPoints === 0) {
                remainingElement.className = 'text-success fw-bold';
            } else {
                remainingElement.className = 'text-warning';
            }
        }
        return;
    }
    
    // 직급별 데이터를 JavaScript 객체로 전달
    const gradeGroups = {{ grade_groups|tojson }};
    
    Object.keys(gradeGroups).forEach(grade => {
        const gradeEvaluatees = gradeGroups[grade];
        let totalPoints = 0;
        
        if (userType === '평가자(팀장)') {
            if (evaluationType === 'employee') {
                totalPoints = gradeEvaluatees.length * 100; // 절대평가
            } else if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 80;
            }
        } else if (userType === '평가자(임원)') {
            if (evaluationType === 'team_leader') {
                totalPoints = gradeEvaluatees.length * 90;
            } else if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 5;
            } else if (evaluationType === 'general') {
                totalPoints = gradeEvaluatees.length * 85;
            }
        }
        
        let usedPoints = 0;
        gradeEvaluatees.forEach(evaluatee => {
            const score = parseInt(document.getElementById(`score-${evaluatee.id}`).value) || 0;
            usedPoints += score;
        });
        
        const remainingPoints = totalPoints - usedPoints;
        const remainingElement = document.getElementById(`remaining-points-${grade}`);
        if (remainingElement) {
            remainingElement.textContent = remainingPoints;
            
            if (remainingPoints < 0) {
                remainingElement.className = 'text-danger fw-bold';
            } else if (remainingPoints === 0) {
                remainingElement.className = 'text-success fw-bold';
            } else {
                remainingElement.className = 'text-warning';
            }
        }
    });
}

// 포인트 한도 검증 함수
function validatePointLimits(evaluationType) {
    const userType = '{{ session["user_type"] }}';
    
    // 포인트 한도 검증이 필요한 경우만 확인
    if (evaluationType === 'general' && userType === '평가자(팀장)') {
        return true; // 팀장-일반직은 의견만 작성하므로 검증 불필요
    }
    
    const gradeGroups = {{ grade_groups|tojson }};
    
    for (const grade in gradeGroups) {
        const gradeEvaluatees = gradeGroups[grade];
        let totalPoints = 0;
        let minPoint = 0, maxPoint = 100;
        
        // 평가 타입별 포인트 한도 설정
        if (userType === '평가자(팀장)') {
            if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 80;
                minPoint = 65;
                maxPoint = 95;
            }
        } else if (userType === '평가자(임원)') {
            if (evaluationType === 'team_leader') {
                totalPoints = gradeEvaluatees.length * 90;
                minPoint = 75;
                maxPoint = 105;
            } else if (evaluationType === 'manager') {
                totalPoints = gradeEvaluatees.length * 5;
                minPoint = 0;
                maxPoint = 10;
            } else if (evaluationType === 'general') {
                totalPoints = gradeEvaluatees.length * 85;
                minPoint = 65;
                maxPoint = 105;
            }
        }
        
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        // 각 평가 대상자의 점수 확인
        for (const evaluatee of gradeEvaluatees) {
            const scoreElement = document.getElementById(`score-${evaluatee.id}`);
            if (!scoreElement) continue;
            
            const score = parseInt(scoreElement.value) || 0;
            
            // 개인별 점수 한도 검증
            if (score < minPoint || score > maxPoint) {
                alert(`${evaluatee.name}의 점수는 ${minPoint}점 이상 ${maxPoint}점 이하여야 합니다.`);
                hasInvalidScore = true;
                break;
            }
            
            usedPoints += score;
        }
        
        if (hasInvalidScore) return false;
        
        // 전체 포인트 한도 검증
        if (usedPoints !== totalPoints) {
            alert(`${grade} 직급의 총 포인트는 ${totalPoints}점이어야 합니다. (현재: ${usedPoints}점)`);
            return false;
        }
    }
    
    return true;
}

// 평가 제출
function submitEvaluation(employeeId, evaluationType) {
    const userType = '{{ session["user_type"] }}';
    let scores = {};
    let comments = document.getElementById(`comments-${employeeId}`).value;
    
    if (evaluationType === 'employee') {
        // 절대평가 데이터 수집
        const radios = document.querySelectorAll(`input[name$="_${employeeId}"]:checked`);
        radios.forEach(radio => {
            scores[radio.name] = radio.value;
        });
    } else if (evaluationType === 'general' && userType === '평가자(팀장)') {
        // 팀장-일반직: 의견만 제출
        scores = {};
    } else {
        // 상대평가 데이터 수집 (임원 일반직 포함)
        const score = document.getElementById(`score-${employeeId}`).value;
        if (!score) {
            alert('평가 점수를 입력해주세요.');
            return;
        }
        
        // 개별 점수 한도 검증
        const scoreInt = parseInt(score, 10);
        let minPoint = 0, maxPoint = 100;
        
        if (userType === '평가자(팀장)' && evaluationType === 'manager') {
            minPoint = 65;
            maxPoint = 95;
        } else if (userType === '평가자(임원)') {
            if (evaluationType === 'team_leader') {
                minPoint = 75;
                maxPoint = 105;
            } else if (evaluationType === 'manager') {
                minPoint = 0;
                maxPoint = 10;
            } else if (evaluationType === 'general') {
                minPoint = 65;
                maxPoint = 105;
            }
        }
        
        if (scoreInt < minPoint || scoreInt > maxPoint) {
            alert(`점수는 ${minPoint}점 이상 ${maxPoint}점 이하여야 합니다.`);
            return;
        }
        
        scores = { score: scoreInt };
    }
    
    const data = {
        evaluatee_id: employeeId,
        evaluation_type: evaluationType,
        scores: scores,
        comments: comments
    };
    
    fetch('/submit_evaluation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('평가가 저장되었습니다.');
        } else {
            alert('오류가 발생했습니다: ' + data.message);
        }
    });
}

// 직급별 역할 정의 전체 보기
function showJobRoleDefinitions() {
    // 모달 내용을 전체 직급 정보로 설정
    document.getElementById('jobTitle').textContent = '직급별 역할 정의';
    
    // 숨겨진 데이터에서 직급 정보 가져오기
    const jobRoleItems = document.querySelectorAll('.job-role-item');
    let allJobInfo = '';
    
    jobRoleItems.forEach(item => {
        const title = item.getAttribute('data-title');
        const definition = item.getAttribute('data-definition');
        const guidelines = item.getAttribute('data-guidelines');
        
        allJobInfo += '<div class="mb-4 border-bottom pb-3">';
        allJobInfo += '<h5 class="text-primary mb-3"><i class="fas fa-user-tie me-2"></i>' + title + '</h5>';
        allJobInfo += '<div class="row">';
        allJobInfo += '<div class="col-md-6">';
        allJobInfo += '<h6 class="text-success mb-2"><i class="fas fa-bullseye me-1"></i>역할 정의</h6>';
        allJobInfo += '<div class="border rounded p-3 mb-3 bg-light">';
        allJobInfo += '<p class="mb-0">' + definition + '</p>';
        allJobInfo += '</div>';
        allJobInfo += '</div>';
        allJobInfo += '<div class="col-md-6">';
        allJobInfo += '<h6 class="text-info mb-2"><i class="fas fa-list-check me-1"></i>행동 지침</h6>';
        allJobInfo += '<div class="border rounded p-3 bg-light">';
        
        // 행동 지침을 줄바꿈으로 분리
        const guidelineList = guidelines.split('\n');
        guidelineList.forEach(guideline => {
            if (guideline.trim()) {
                allJobInfo += '<p class="mb-1">' + guideline.trim() + '</p>';
            }
        });
        
        allJobInfo += '</div>';
        allJobInfo += '</div>';
        allJobInfo += '</div>';
        allJobInfo += '</div>';
    });
    
    document.getElementById('jobDefinition').innerHTML = allJobInfo;
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
    modal.show();
}

// 직급별 역할 정의 상세 정보 표시 (개별 직급)
function showJobDetail(jobTitle, jobDefinition, jobGuidelines) {
    document.getElementById('jobTitle').textContent = jobTitle;
    document.getElementById('jobDefinition').textContent = jobDefinition;
    
    // 행동 지침을 줄바꿈으로 분리하여 리스트로 표시
    const guidelines = jobGuidelines.split('\n').filter(line => line.trim() !== '');
    let guidelinesHtml = '';
    guidelines.forEach(guideline => {
        if (guideline.trim()) {
            guidelinesHtml += '<p class="mb-1">' + guideline.trim() + '</p>';
        }
    });
    document.getElementById('jobGuidelines').innerHTML = guidelinesHtml;
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('jobDetailModal'));
    modal.show();
}

// 이벤트 리스너 등록
document.addEventListener('DOMContentLoaded', function() {
    // 절대평가 라디오 버튼 이벤트
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            const employeeId = this.name.split('_').pop();
            calculateTotalScore(employeeId);
        });
    });
    
    // 상대평가 점수 입력 이벤트
    const scoreInputs = document.querySelectorAll('.score-input');
    scoreInputs.forEach(input => {
        input.addEventListener('input', function() {
            calculateRemainingPoints();
        });
    });
    
    // 초기 포인트 계산
    if ('{{ evaluation_type }}' !== 'general') {
        calculateRemainingPoints();
    }
});

// 점수 조정 함수 (±15점)
function adjustScore(employeeId, adjustment) {
    const scoreInput = document.getElementById(`score-${employeeId}`);
    if (!scoreInput) return;
    
    let currentScore = parseInt(scoreInput.value) || 0;
    let newScore = currentScore + adjustment;
    
    // 최소/최대 점수 제한
    const minScore = 65;
    const maxScore = 95;
    
    if (newScore < minScore) {
        newScore = minScore;
    } else if (newScore > maxScore) {
        newScore = maxScore;
    }
    
    scoreInput.value = newScore;
    calculateRemainingPoints(); // 남은 포인트 재계산
    checkScoreDifference(employeeId); // 점수 차이 확인
}

// 점수 입력 시 직전 점수 대비 차이 확인
function checkScoreDifference(employeeId) {
    const scoreInput = document.getElementById(`score-${employeeId}`);
    if (!scoreInput) return;
    
    const currentScore = parseInt(scoreInput.value) || 0;
    const beforePoint = parseInt(scoreInput.getAttribute('data-before-point')) || 0;
    
    if (beforePoint > 0) {
        const difference = Math.abs(currentScore - beforePoint);
        if (difference >= 15) {
            // 소명서 작성 안내 표시
            const explanationDiv = document.getElementById(`explanation-${employeeId}`);
            if (explanationDiv) {
                explanationDiv.style.display = 'block';
                explanationDiv.innerHTML = `
                    <div class="alert alert-warning mt-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>소명서 작성 필요</strong><br>
                        직전 점수(${beforePoint}점) 대비 ${difference}점 차이가 발생했습니다.<br>
                        소명서를 작성해주세요.<br>
                        <small class="text-muted">(소명서 양식은 인사기획팀 문수한 대리에게 요청)</small>
                    </div>
                `;
            }
        } else {
            // 소명서 안내 숨기기
            const explanationDiv = document.getElementById(`explanation-${employeeId}`);
            if (explanationDiv) {
                explanationDiv.style.display = 'none';
            }
        }
    }
}

function saveEvaluationsTemporary(evaluationType) {
    const userType = '{{ session["user_type"] }}';
    
    // 팀장의 경우 포인트 한도 검증 추가
    if (userType === '평가자(팀장)' && evaluationType === 'manager') {
        // 팀장은 전체 평가자에 대해 포인트 한도 검증
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 80;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 65 || score > 95) {
                alert(`점수는 65점 이상 95점 이하여야 합니다. (현재: ${score}점)`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`총 포인트는 ${totalPoints}점이어야 합니다. (현재: ${usedPoints}점)`);
            return;
        }
    }
    
    // 임원의 팀장 평가 한도 검증 추가
    if (userType === '평가자(임원)' && evaluationType === 'team_leader') {
        // 임원은 전체 팀장에 대해 포인트 한도 검증
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 90;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 75 || score > 105) {
                alert(`점수는 75점 이상 105점 이하여야 합니다. (현재: ${score}점)`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`총 포인트는 ${totalPoints}점이어야 합니다. (현재: ${usedPoints}점)`);
            return;
        }
    }
    
    // 임원의 팀원 평가(관리직) 한도 검증 추가
    if (userType === '평가자(임원)' && evaluationType === 'manager') {
        // 임원은 전체 관리직에 대해 포인트 한도 검증
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 5;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 0 || score > 10) {
                alert(`점수는 0점 이상 10점 이하여야 합니다. (현재: ${score}점)`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`총 포인트는 ${totalPoints}점이어야 합니다. (현재: ${usedPoints}점)`);
            return;
        }
    }
    
    // 임원의 팀원 평가(일반직) 한도 검증 추가
    if (userType === '평가자(임원)' && evaluationType === 'general') {
        // 임원은 전체 일반직에 대해 포인트 한도 검증
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 85;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 65 || score > 105) {
                alert(`점수는 65점 이상 105점 이하여야 합니다. (현재: ${score}점)`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`총 포인트는 ${totalPoints}점이어야 합니다. (현재: ${usedPoints}점)`);
            return;
        }
    }
    
    // 평가자(팀장)는 개별 임시저장, 평가자(임원)는 일괄 임시저장
    if (userType === '평가자(팀장)') {
        // 개별 임시저장
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let savedCount = 0;
        let totalCount = 0;
        
        items.forEach(el => {
            let eid, scores = {}, commentsVal = '';
            
            if (evaluationType === 'employee') {
                // 절대평가: ID에서 추출
                eid = el.id.replace('evaluatee-', '');
                // 라디오 버튼 데이터 수집
                const radios = document.querySelectorAll(`input[name$="_${eid}"]:checked`);
                radios.forEach(radio => {
                    scores[radio.name] = radio.value;
                });
            } else {
                // 상대평가: data-eid 속성 사용
                eid = el.getAttribute('data-eid');
                if (!eid) return;
                const scoreEl = document.getElementById(`score-${eid}`);
                const scoreVal = scoreEl ? scoreEl.value : '';
                scores = { score: scoreVal ? parseInt(scoreVal, 10) : 0 };
            }
            
            // eid가 있는 경우에만 처리
            if (eid) {
                const commentsEl = document.getElementById(`comments-${eid}`);
                commentsVal = commentsEl ? commentsEl.value : '';
                
                totalCount++;
                
                fetch('/submit_evaluation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        evaluatee_id: eid,
                        evaluation_type: evaluationType,
                        scores: scores,
                        comments: commentsVal || ''
                    })
                }).then(r => r.json()).then(res => {
                    savedCount++;
                    if (res.success) {
                        if (savedCount === totalCount) {
                            alert(`총 ${savedCount}건의 평가가 임시저장되었습니다.`);
                        }
                    } else {
                        alert(res.message || '임시저장 중 오류가 발생했습니다.');
                    }
                }).catch(err => {
                    alert('임시저장 중 오류가 발생했습니다.');
                    console.error(err);
                });
            }
        });
        
        if (totalCount === 0) {
            alert('임시저장할 평가가 없습니다.');
        }
    } else {
        // 임원의 경우 일괄 임시저장
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        const evaluations = [];
        items.forEach(el => {
            let eid, scores = {}, commentsVal = '';
            
            if (evaluationType === 'employee') {
                // 절대평가: ID에서 추출
                eid = el.id.replace('evaluatee-', '');
                // 라디오 버튼 데이터 수집
                const radios = document.querySelectorAll(`input[name$="_${eid}"]:checked`);
                radios.forEach(radio => {
                    scores[radio.name] = radio.value;
                });
            } else {
                // 상대평가: data-eid 속성 사용
                eid = el.getAttribute('data-eid');
                if (!eid) return;
                const scoreEl = document.getElementById(`score-${eid}`);
                const scoreVal = scoreEl ? scoreEl.value : '';
                scores = { score: scoreVal ? parseInt(scoreVal, 10) : 0 };
            }
            
            const commentsEl = document.getElementById(`comments-${eid}`);
            commentsVal = commentsEl ? commentsEl.value : '';
            
            evaluations.push({
                evaluatee_id: eid,
                scores: scores,
                comments: commentsVal || ''
            });
        });
        
        if (evaluations.length === 0) {
            alert('임시저장할 평가가 없습니다.');
            return;
        }
        
        fetch('/submit_evaluations_bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ evaluation_type: evaluationType, evaluations })
        }).then(r => r.json()).then(res => {
            if (res.success) {
                alert(`총 ${res.count}건의 평가가 임시저장되었습니다.`);
            } else {
                alert(res.message || '임시저장 중 오류가 발생했습니다.');
            }
        });
    }
}

function submitEvaluationsBulk(evaluationType) {
    const userType = '{{ session["user_type"] }}';
    
    // 팀장의 경우 포인트 한도 검증 방식이 다름 (평면 리스트)
    if (userType === '평가자(팀장)' && evaluationType === 'manager') {
        // 팀장은 전체 평가자에 대해 포인트 한도 검증
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let totalPoints = items.length * 80;
        let usedPoints = 0;
        let hasInvalidScore = false;
        
        for (let i = 0; i < items.length; i++) {
            const el = items[i];
            const eid = el.getAttribute('data-eid');
            if (!eid) continue;
            const scoreEl = document.getElementById(`score-${eid}`);
            if (!scoreEl || !scoreEl.value) continue;
            
            const score = parseInt(scoreEl.value);
            if (score < 65 || score > 95) {
                alert(`점수는 65점 이상 95점 이하여야 합니다. (현재: ${score}점)`);
                hasInvalidScore = true;
                break;
            }
            usedPoints += score;
        }
        
        if (hasInvalidScore) return;
        
        if (usedPoints !== totalPoints) {
            alert(`총 포인트는 ${totalPoints}점이어야 합니다. (현재: ${usedPoints}점)`);
            return;
        }
    } else {
        // 임원의 경우 기존 검증 방식 사용
        if (!validatePointLimits(evaluationType)) {
            return; // 검증 실패 시 제출 중단
        }
    }
    
    // 평가자(팀장)는 개별 제출, 평가자(임원)는 일괄 제출
    if (userType === '평가자(팀장)') {
        // 개별 제출
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        let submittedCount = 0;
        let totalCount = 0;
        
        items.forEach(el => {
    let eid, scores = {}, commentsVal = '';
    
    if (evaluationType === 'employee') {
        // 절대평가: ID에서 추출
        eid = el.id.replace('evaluatee-', '');
        // 라디오 버튼 데이터 수집
        const radios = document.querySelectorAll(`input[name$="_${eid}"]:checked`);
        if (radios.length === 0) return; // 라디오 버튼이 선택되지 않은 경우 제외
        radios.forEach(radio => {
            scores[radio.name] = radio.value;
        });
    } else {
        // 상대평가: data-eid 속성 사용
        eid = el.getAttribute('data-eid');
        if (!eid) return;
        const scoreEl = document.getElementById(`score-${eid}`);
        const scoreVal = scoreEl ? scoreEl.value : '';
        
        // 일반직 평가는 점수가 없어도 코멘트만 있어도 제출 가능
        if (evaluationType === 'general' && userType === '평가자(팀장)') {
            // 일반직 평가는 점수 없이도 제출 가능
            scores = scoreVal ? { score: parseInt(scoreVal, 10) } : {};
        } else {
            // 다른 평가는 점수가 있어야 제출 가능
            if (scoreVal === '') return; // 점수 없는 항목은 제외
            scores = { score: parseInt(scoreVal, 10) };
        }
    }
    
    const commentsEl = document.getElementById(`comments-${eid}`);
    commentsVal = commentsEl ? commentsEl.value : '';
    
    // 일반직 평가는 코멘트가 있어야 제출 가능
    if (evaluationType === 'general' && userType === '평가자(팀장)') {
        if (!commentsVal.trim()) return; // 코멘트가 없으면 제외
    }
            
    totalCount++;
            
            fetch('/submit_evaluation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    evaluatee_id: eid,
                    evaluation_type: evaluationType,
                    scores: scores,
                    comments: commentsVal || ''
                })
            }).then(r => r.json()).then(res => {
                submittedCount++;
                if (res.success) {
                    if (submittedCount === totalCount) {
                        // 모든 개별 제출이 완료되면 최종제출 처리
                        fetch('/finalize_evaluation', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ evaluation_type: evaluationType })
                        }).then(r => r.json()).then(finalizeRes => {
                            if (finalizeRes.success) {
                                alert(`총 ${submittedCount}건의 평가가 최종제출되었습니다.`);
                                // 페이지 새로고침하여 최종제출 상태 반영
                                location.reload();
                            } else {
                                alert(finalizeRes.message || '최종제출 중 오류가 발생했습니다.');
                            }
                        });
                    }
                } else {
                    alert(res.message || '제출 중 오류가 발생했습니다.');
                }
            }).catch(err => {
                alert('제출 중 오류가 발생했습니다.');
                console.error(err);
            });
        });
        
        if (totalCount === 0) {
            alert('제출할 평가가 없습니다. 점수를 입력하세요.');
        }
    } else {
        // 임원의 경우 일괄 제출
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        const evaluations = [];
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (!eid) return;
            const scoreEl = document.getElementById(`score-${eid}`);
            const commentsEl = document.getElementById(`comments-${eid}`);
            const scoreVal = scoreEl ? scoreEl.value : '';
            const commentsVal = commentsEl ? commentsEl.value : '';
            if (scoreVal === '') return; // 점수 없는 항목은 제외
            evaluations.push({
                evaluatee_id: eid,
                scores: { score: parseInt(scoreVal, 10) },
                comments: commentsVal || ''
            });
        });
        if (evaluations.length === 0) {
            alert('제출할 평가가 없습니다. 점수를 입력하세요.');
            return;
        }
        fetch('/submit_evaluations_bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ evaluation_type: evaluationType, evaluations })
        }).then(r => r.json()).then(res => {
            if (res.success) {
                // 최종제출 처리
                fetch('/finalize_evaluation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ evaluation_type: evaluationType })
                }).then(r => r.json()).then(finalizeRes => {
                    if (finalizeRes.success) {
                        alert(`총 ${res.count}건의 평가가 최종제출되었습니다.`);
                        // 페이지 새로고침하여 최종제출 상태 반영
                        location.reload();
                    } else {
                        alert(finalizeRes.message || '최종제출 중 오류가 발생했습니다.');
                    }
                });
            } else {
                alert(res.message || '제출 중 오류가 발생했습니다.');
            }
        });
    }
}

// 최종제출 상태 확인 및 폼 비활성화
function checkFinalSubmitStatus() {
    const evaluationType = '{{ evaluation_type }}';
    
    fetch(`/check_final_submit_status/${evaluationType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.is_finalized) {
                // 최종제출된 경우 폼 비활성화
                disableEvaluationForm();
                showFinalizedMessage();
            } else {
                // 미제출인 경우 저장된 데이터 로드
                loadSavedEvaluations();
            }
        })
        .catch(error => {
            console.error('최종제출 상태 확인 오류:', error);
            // 오류 시에도 저장된 데이터 로드 시도
            loadSavedEvaluations();
        });
}

// 폼 비활성화
function disableEvaluationForm() {
    // 최종제출된 데이터도 로드
    loadSavedEvaluations();
    
    // 모든 입력 요소 비활성화
    const inputs = document.querySelectorAll('input, textarea, button');
    inputs.forEach(input => {
        if (!input.classList.contains('btn-performance-view')) { // 실적 조회 버튼은 제외
            input.disabled = true;
            input.style.opacity = '0.6';
        }
    });
    
    // 임시저장/최종제출 버튼 숨기기
    const tempSaveBtns = document.querySelectorAll('.btn-temp-save');
    const finalSubmitBtns = document.querySelectorAll('.btn-final-submit');
    
    tempSaveBtns.forEach(btn => btn.style.display = 'none');
    finalSubmitBtns.forEach(btn => btn.style.display = 'none');
}

// 최종제출 완료 메시지 표시
function showFinalizedMessage() {
    const evaluationType = '{{ evaluation_type }}';
    const evaluationTypeName = evaluationType === 'employee' ? '사원 평가' : 
                              evaluationType === 'manager' ? '관리직 평가' : 
                              evaluationType === 'general' ? '일반직 평가' : 
                              evaluationType === 'team_leader' ? '팀장 평가' : '평가';
    
    // 페이지 상단에 알림 표시
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>최종제출 완료</strong><br>
        ${evaluationTypeName}이 최종제출되었습니다. 수정이 불가능합니다.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 페이지 상단에 삽입
    const container = document.querySelector('.container-fluid') || document.querySelector('.container');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
    }
}

// 페이지 로드 시 저장된 평가 데이터 불러오기
function loadSavedEvaluations() {
    const evaluationType = '{{ evaluation_type }}';
    
    fetch(`/get_saved_evaluation/${evaluationType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                Object.keys(data.data).forEach(evaluateeId => {
                    const savedData = data.data[evaluateeId];
                    
                    // 절대평가인 경우 라디오 버튼 설정
                    if (evaluationType === 'employee') {
                        Object.keys(savedData.scores).forEach(radioName => {
                            const radio = document.querySelector(`input[name="${radioName}"][value="${savedData.scores[radioName]}"]`);
                            if (radio) {
                                radio.checked = true;
                                // 총점 계산
                                const employeeId = radioName.split('_').pop();
                                calculateTotalScore(employeeId);
                            }
                        });
                    } else {
                        // 상대평가인 경우 점수 입력
                        const scoreInput = document.getElementById(`score-${evaluateeId}`);
                        if (scoreInput && savedData.scores.score) {
                            scoreInput.value = savedData.scores.score;
                            // 합계 점수 업데이트 (임원의 관리직 평가인 경우만)
                            if ('{{ session["user_type"] }}' === '평가자(임원)' && evaluationType === 'manager') {
                                updateTotalScore(evaluateeId);
                            }
                            // 팀장평가(evaluationType === 'team_leader')에서는 합계 점수 계산하지 않음
                        }
                    }
                    
                    // 평가 의견 설정
                    const commentsInput = document.getElementById(`comments-${evaluateeId}`);
                    if (commentsInput) {
                        commentsInput.value = savedData.comments || '';
                    }
                });
                
                // 포인트 계산 업데이트
                calculateRemainingPoints();
            }
        })
        .catch(error => {
            console.error('저장된 평가 데이터 로드 오류:', error);
        });
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 최종제출 상태 확인 (먼저 실행)
    checkFinalSubmitStatus();
    
    // 평가자(임원)의 팀원 평가(관리직)에서 초기 합계 점수 표시
    const userType = '{{ session["user_type"] }}';
    const evaluationType = '{{ evaluation_type }}';
    
    if (userType === '평가자(임원)' && evaluationType === 'manager') {
        const items = evaluationType === 'employee' ? document.querySelectorAll('.evaluation-card') : document.querySelectorAll('.evaluatee-item');
        items.forEach(el => {
            const eid = el.getAttribute('data-eid');
            if (eid) {
                updateTotalScore(eid);
            }
        });
    }
    // 팀장평가(evaluationType === 'team_leader')에서는 합계 점수 계산하지 않음
});
</script>
{% endblock %} 